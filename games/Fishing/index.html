<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>æ”¾ç½®é‡£é­š</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Fishing" />

  <link rel="manifest" href="/game/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/game/icons/icon-192.png">

  <style>
    :root{
      color-scheme: dark light;
      --maxw: 920px;
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
      --pad: 12px;
    }
    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:#121b2e;
      --card2:#0f1728;
      --border:rgba(255,255,255,.10);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.72);
      --btn:#1b2640;
      --btn2:#223155;
      --accent:#57b8ff;
      --good:#7cf7b6;
      --warn:#ffcc66;
      --bad:#ff668a;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#f0f3fb;
      --border:rgba(0,0,0,.10);
      --text:#0b1220;
      --muted:rgba(11,18,32,.70);
      --btn:#ffffff;
      --btn2:#eef2fb;
      --accent:#1e79c8;
      --good:#1ea972;
      --warn:#d9822b;
      --bad:#d23a5a;
    }

    html, body{
      margin:0; height:100%;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
      overscroll-behavior: none;
    }
    body{ overflow:auto; }

    .app{
      min-height:100svh;
      padding-top: calc(var(--safeTop) + var(--pad));
      padding-left: calc(var(--safeL) + var(--pad));
      padding-right: calc(var(--safeR) + var(--pad));
      padding-bottom: calc(var(--safeBot) + var(--pad) + 90px); /* é ç•™å³ä¸‹è§’æµ®å‹•éˆ• */
      display:flex;
      justify-content:center;
      box-sizing:border-box;
    }
    .wrap{
      width:min(var(--maxw), 96vw);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .top .left, .top .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      font-weight:900;
      min-height:46px;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
    }
    .btn:active{ transform:scale(.985); }
    .btn.primary{
      background:var(--btn2);
      border-color: color-mix(in oklab, var(--accent), var(--border) 60%);
    }
    .btn.danger{
      background: color-mix(in oklab, var(--bad), var(--btn) 70%);
      border-color: color-mix(in oklab, var(--bad), var(--border) 60%);
    }

    .stat{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      font-weight:900;
      white-space:nowrap;
    }
    .stat b{ color:var(--accent); }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:16px;
      padding:14px;
      box-sizing:border-box;
    }
    .card h2{ margin:0 0 10px; font-size:16px; letter-spacing:.2px; }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .kpi{ grid-template-columns:1fr; }
    }

    .kpiBox{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:14px;
      padding:12px;
    }
    .kpiBox .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    .kpiBox .value{
      font-size:18px;
      font-weight:1000;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    .pill{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
    }
    .pill b{ color:var(--accent); }

    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card2);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: color-mix(in oklab, var(--accent), #fff 18%);
    }

    .list{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:14px;
      padding:10px;
      box-sizing:border-box;
      max-height: 52svh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .logItem{
      border-bottom:1px solid var(--border);
      padding:10px 6px;
    }
    .logItem:last-child{ border-bottom:none; }
    .logT{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      font-weight:800;
    }
    .logM{
      font-size:14px;
      font-weight:900;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      top: calc(var(--safeTop) + 10px);
      transform:translateX(-50%);
      z-index:1000;
      border:1px solid var(--border);
      background:var(--card);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:1000;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(6px); }
    .toast b{ color:var(--accent); }

    /* å³ä¸‹è§’æ§åˆ¶éˆ• */
    .fab{
      position:fixed;
      right: calc(var(--safeR) + 14px);
      bottom: calc(var(--safeBot) + 14px);
      z-index:1100;
      border:1px solid var(--border);
      background:var(--btn2);
      color:var(--text);
      border-radius:999px;
      padding:14px 16px;
      font-size:15px;
      font-weight:1000;
      min-height:52px;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .fab:active{ transform:scale(.985); }

    dialog{
      width:min(860px, 94vw);
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
      padding:0;
    }
    dialog::backdrop{ background: rgba(0,0,0,.35); }
    .dlgHead{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dlgHead h3{ margin:0; font-size:15px; }
    .dlgBody{ padding:14px; display:flex; flex-direction:column; gap:10px; }

    .opt{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .opt .l{ display:flex; flex-direction:column; gap:4px; }
    .opt .t{ font-weight:1000; }
    .opt .d{ font-size:12px; color:var(--muted); font-weight:800; }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:1000;
      min-height:40px;
      cursor:pointer;
    }
    .seg button.active{
      background:var(--btn2);
      border-color: color-mix(in oklab, var(--accent), var(--border) 60%);
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
    }
    .toggle input{ width:20px; height:20px; }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:12px;
      font-size:13px;
      line-height:1.4;
      outline:none;
      box-sizing:border-box;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="wrap">
      <div class="top">
        <div class="left">
          <button class="btn" id="backBtn">â† Back</button>
          <button class="btn primary" id="themeBtn">ä¸»é¡Œï¼šæ·±è‰²</button>
          <button class="btn" id="saveBtn">å­˜æª”ç¢¼</button>
          <button class="btn" id="bagBtn">èƒŒåŒ…/åœ–é‘‘</button>
          <button class="btn" id="questBtn">ä»»å‹™</button>
        </div>
        <div class="right">
          <div class="stat">é‡‘å¹£ï¼š<b id="gold">0</b></div>
          <div class="stat">é‡£ç«¿ï¼šLv <b id="rodLv">1</b></div>
          <div class="stat">èƒŒåŒ…ï¼š<b id="bagStat">0/30</b></div>
          <div class="stat">æ°´åŸŸï¼š<b id="zoneName">æ–°æ‰‹æ± </b></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>ç‹€æ…‹</h2>
          <div class="kpi">
            <div class="kpiBox">
              <div class="label">æ´¾é£</div>
              <div class="value" id="status">å¾…å‘½</div>
            </div>
            <div class="kpiBox">
              <div class="label">å‰©é¤˜</div>
              <div class="value" id="remain">â€”</div>
            </div>
            <div class="kpiBox">
              <div class="label">æœ¬è¼ªç”¢å‡º</div>
              <div class="value" id="cycleOut">â€”</div>
            </div>
            <div class="kpiBox">
              <div class="label">è‡ªå‹•è³£å‡º</div>
              <div class="value" id="autoSellView">é–‹</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="pill">é‡£ç«¿å‡ç´šè²»ï¼š<b id="rodCost">â€”</b></div>
            <button class="btn primary" id="rodUpBtn">å‡ç´šé‡£ç«¿</button>

            <div class="pill">èƒŒåŒ…æ“´å……è²»ï¼š<b id="bagCost">â€”</b></div>
            <button class="btn primary" id="bagUpBtn">æ“´å……èƒŒåŒ…</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="pill">æ°´åŸŸè§£é–è²»ï¼š<b id="zoneCost">â€”</b></div>
            <button class="btn primary" id="zoneUpBtn">è§£é–æ°´åŸŸ</button>
            <div class="pill">ç›®å‰é€±æœŸï¼š<b id="cycleSecView">â€”</b></div>
          </div>

          <div style="margin-top:12px;">
            <div class="pill" style="display:inline-flex;">é€²åº¦ï¼ˆè·é›¢ä¸‹ä¸€è¼ªï¼‰</div>
            <div class="bar" style="margin-top:8px;"><div id="prog"></div></div>
          </div>

          <div class="hint" style="margin-top:10px;">
            60 åˆ†æ´¾é£ä»¥å‰ä½ æœƒçˆ†å€‰ï¼Ÿç¾åœ¨é€±æœŸæ›´æ…¢ + å¯æ“´åŒ…ï¼Œæ”¾ç½®æ‰æœ‰å•†æ¥­åƒ¹å€¼ã€‚
          </div>
        </div>

        <div class="card">
          <h2>ç´€éŒ„</h2>
          <div class="list" id="log"></div>
          <div class="row">
            <div class="pill">ç¸½é‡£ç²ï¼š<b id="totalCatch">0</b></div>
            <div class="pill">ç¸½è³£å‡ºï¼š<b id="totalSold">0</b></div>
            <div class="pill">ç´¯ç©é‡‘å¹£ï¼š<b id="totalGold">0</b></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ§åˆ¶å…¥å£ -->
  <button class="fab" id="ctrlBtn">âš™ æ§åˆ¶</button>

  <!-- æ§åˆ¶é¢æ¿ -->
  <dialog id="dlgCtrl">
    <div class="dlgHead">
      <h3>æ§åˆ¶</h3>
      <button class="btn" id="closeCtrl">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="opt">
        <div class="l">
          <div class="t">æ´¾é£æ™‚é•·</div>
          <div class="d">åˆ°æ™‚è‡ªå‹•åœæ­¢</div>
        </div>
        <div class="seg" id="durSeg">
          <button data-min="5">5åˆ†</button>
          <button data-min="15" class="active">15åˆ†</button>
          <button data-min="60">60åˆ†</button>
        </div>
      </div>

      <div class="opt">
        <div class="l">
          <div class="t">è‡ªå‹•è³£å‡º</div>
          <div class="d">èƒŒåŒ…æ»¿äº†å°±è‡ªå‹•è³£ï¼ŒçœŸæ­£æ”¾ç½®</div>
        </div>
        <div class="toggle">
          <input type="checkbox" id="autoSell">
          <label for="autoSell" style="font-weight:1000;">é–‹</label>
        </div>
      </div>

      <div class="opt">
        <div class="l">
          <div class="t">æ´¾é£æ§åˆ¶</div>
          <div class="d">é–‹å§‹å¾Œæœƒè‡ªå‹•å¾ªç’°ç”¢å‡º</div>
        </div>
        <div class="seg">
          <button class="active" id="startBtn">é–‹å§‹</button>
          <button id="stopBtn">åœæ­¢</button>
        </div>
      </div>

      <div class="opt">
        <div class="l">
          <div class="t">æ‰‹å‹•æ“ä½œ</div>
          <div class="d">éœ€è¦æ™‚å†ç”¨ï¼Œä¸ç”¨ä¸€ç›´æŒ‰</div>
        </div>
        <div class="seg">
          <button id="sellBtn">è³£å…‰</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- å­˜æª”ç¢¼ -->
  <dialog id="dlgSave">
    <div class="dlgHead">
      <h3>å­˜æª”ç¢¼</h3>
      <button class="btn" id="closeSave">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <textarea id="saveText" spellcheck="false" placeholder="å­˜æª”ç¢¼â€¦"></textarea>
      <div class="row">
        <button class="btn primary" id="btnExport">åŒ¯å‡º</button>
        <button class="btn" id="btnCopy">è¤‡è£½</button>
        <button class="btn primary" id="btnImport">åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
        <button class="btn danger" id="btnReset">é‡ç½®</button>
      </div>
      <div class="hint">å­˜æª”ç¢¼åŒ…å«æ‰€æœ‰é€²åº¦ï¼ˆé‡£ç«¿/æ°´åŸŸ/èƒŒåŒ…/ä»»å‹™/æˆå°±ï¼‰ã€‚</div>
    </div>
  </dialog>

  <!-- èƒŒåŒ… -->
  <dialog id="dlgBag">
    <div class="dlgHead">
      <h3>èƒŒåŒ… / åœ–é‘‘</h3>
      <button class="btn" id="closeBag">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="row">
        <div class="pill">èƒŒåŒ…ï¼š<b id="bag2">0</b>/<b id="bagCap2">30</b></div>
        <div class="pill">åœ–é‘‘ï¼š<b id="dex2">0</b>/<b id="dexAll2">0</b></div>
      </div>
      <div class="list" id="bagList" style="max-height:56svh;"></div>
    </div>
  </dialog>

  <!-- ä»»å‹™ -->
  <dialog id="dlgQuest">
    <div class="dlgHead">
      <h3>ä»»å‹™ / æˆå°±</h3>
      <button class="btn" id="closeQuest">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="opt">
        <div class="l">
          <div class="t">æ¯æ—¥ä»»å‹™ï¼ˆæ¯å¤© 00:00 é‡ç½®ï¼‰</div>
          <div class="d">åšå®Œå°±é ˜çï¼Œè®“ä½ æ›æ©Ÿæœ‰ KPIã€æœ‰å›å ±</div>
        </div>
      </div>
      <div class="list" id="dailyList" style="max-height:32svh;"></div>

      <div class="opt">
        <div class="l">
          <div class="t">æˆå°±ï¼ˆä¸€æ¬¡æ€§ï¼‰</div>
          <div class="d">é•·æœŸç›®æ¨™ï¼Œä¸å†åªæ˜¯ç„¡é™å‡ç´š</div>
        </div>
      </div>
      <div class="list" id="achList" style="max-height:32svh;"></div>
    </div>
  </dialog>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
  const now = () => Date.now();
  const fmtInt = (n) => String(Math.floor(n));

  const toast = $("toast");
  let toastTimer = 0;
  function showToast(msg, ms=900){
    toast.innerHTML = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
  }

  // Theme
  const THEME_KEY = "idle_fishing_theme_v4";
  function systemTheme(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
  }
  function applyTheme(mode){
    const final = (mode === "system") ? systemTheme() : mode;
    document.documentElement.dataset.theme = final;
    const meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute("content", final === "light" ? "#f6f7fb" : "#0b1220");
    $("themeBtn").textContent = `ä¸»é¡Œï¼š${final === "light" ? "æ·ºè‰²" : "æ·±è‰²"}`;
  }
  function getThemeMode(){ return localStorage.getItem(THEME_KEY) || "system"; }
  function setThemeMode(mode){ localStorage.setItem(THEME_KEY, mode); applyTheme(mode); }
  applyTheme(getThemeMode());
  $("themeBtn").addEventListener("click", () => {
    const cur = document.documentElement.dataset.theme;
    setThemeMode(cur === "light" ? "dark" : "light");
  });

  // Back
  $("backBtn").addEventListener("click", () => {
    const hub = "/game/";
    try{
      if(document.referrer && document.referrer.includes("/game/")) history.back();
      else location.href = hub;
    }catch(_){
      location.href = hub;
    }
  });

  // =========================
  // DATA
  // =========================

  // âœ… ç¨€æœ‰åº¦ï¼šå°‘è¦‹ -> é«˜ç´š
  const RAR = {
    C: {name:"æ™®é€š", mult:1.0},
    U: {name:"é«˜ç´š", mult:1.6},     // <- é€™è£¡æ”¹å
    R: {name:"ç¨€æœ‰", mult:2.6},
    E: {name:"å²è©©", mult:4.2},
    L: {name:"å‚³èªª", mult:7.0},
  };

  // âœ… é€±æœŸè®Šæ…¢ï¼Œ60 åˆ†æ´¾é£æ‰æœ‰æ„ç¾©ï¼ˆä¸ç„¶èƒŒåŒ…å¿…çˆ†ï¼‰
  // pond: 60s / river: 75s / lake: 90s  (é‡£ç«¿ä»æœƒç¸®çŸ­ï¼Œä½†ä¸æœƒçŸ­åˆ°å¤±æ§)
  const ZONES = [
    { id:"pond", name:"æ–°æ‰‹æ± ", unlockGold:0, baseCycleSec:60,
      fish:[
        {id:"minnow",  name:"å°éŠ€é­š", base: 6,  rar:"C", w:60},
        {id:"carp",    name:"é¯‰é­š",   base:10,  rar:"C", w:45},
        {id:"catfish", name:"é¯°é­š",   base:16,  rar:"U", w:24},
        {id:"eel",     name:"é°»é­š",   base:22,  rar:"R", w:10},
        {id:"koi",     name:"éŒ¦é¯‰",   base:40,  rar:"E", w:4},
      ]},
    { id:"river", name:"æºªæµ", unlockGold:600, baseCycleSec:75,
      fish:[
        {id:"trout",   name:"é±’é­š",   base:18,  rar:"C", w:55},
        {id:"bass",    name:"é±¸é­š",   base:26,  rar:"U", w:28},
        {id:"pike",    name:"ç‹—é­š",   base:38,  rar:"R", w:12},
        {id:"golden",  name:"é‡‘é±—é­š", base:60,  rar:"E", w:4},
        {id:"spirit",  name:"éˆæ°´é­š", base:95,  rar:"L", w:1},
      ]},
    { id:"lake", name:"æ·±æ¹–", unlockGold:2600, baseCycleSec:90,
      fish:[
        {id:"perch",    name:"æ²³é±¸",   base:28,  rar:"C", w:52},
        {id:"tilapia",  name:"å³éƒ­é­š", base:34,  rar:"U", w:30},
        {id:"sturgeon", name:"é±˜é­š",   base:70,  rar:"R", w:12},
        {id:"moon",     name:"æœˆå½±é­š", base:120, rar:"E", w:5},
        {id:"ancient",  name:"å¤ä»£é­š", base:180, rar:"L", w:1},
      ]},
  ];

  const ALL_FISH_IDS = Array.from(new Set(ZONES.flatMap(z => z.fish.map(f => f.id))));
  $("dexAll2").textContent = ALL_FISH_IDS.length;

  // =========================
  // SAVE
  // =========================
  const SAVE_KEY = "idle_fishing_save_v4";
  const SAVE_VER = 1;

  let S = null;

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function defaultState(){
    return {
      v: SAVE_VER,
      gold: 0,
      totalGold: 0,
      totalCatch: 0,
      totalSold: 0,
      rodLv: 1,
      zoneIdx: 0,

      // âœ… èƒŒåŒ…å¯æ“´å……ï¼šcap = 30 + bagLv*15
      bagLv: 0,
      bagCap: 30,

      bag: [],
      dex: {},
      log: [],
      settings: {
        autoSell: true,
        dispatchMin: 15
      },

      // âœ… ä»»å‹™/æˆå°±
      meta: {
        dailyKey: todayKey(),
        daily: { catch:0, sell:0, newDex:0, claim:{} },
        achClaim: {}
      },

      // âœ… æ´¾é£ï¼ˆæ”¾ç½®ï¼‰
      dispatch: {
        active: false,
        startAt: 0,
        endAt: 0,
        zoneIdx: 0,
        cycleSec: 60,
        nextTickAt: 0,
        lastCycleOut: 0
      }
    };
  }

  function saveLocal(){
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }catch(_){}
  }
  function loadLocal(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }

  function pushLog(msg){
    const t = new Date().toLocaleString();
    S.log.unshift({t, msg});
    if(S.log.length > 80) S.log.pop();
    renderLog();
  }

  // Save code
  function b64encode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }
  function b64decode(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
  function checksum(str){
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619) >>> 0;
    }
    return (h >>> 0).toString(36).toUpperCase().padStart(6, "0").slice(0,6);
  }
  function exportCode(){
    const json = JSON.stringify(S);
    const b64 = b64encode(json);
    return `v${SAVE_VER}:${b64}:${checksum(b64)}`;
  }
  function importCode(code){
    const m = String(code || "").trim().match(/^v(\d+):([A-Za-z0-9+/=]+):([A-Za-z0-9]+)$/);
    if(!m) throw new Error("æ ¼å¼ä¸æ­£ç¢º");
    const b64 = m[2];
    const chk = m[3].toUpperCase();
    if(checksum(b64) !== chk) throw new Error("æ ¡é©—å¤±æ•—");
    const obj = JSON.parse(b64decode(b64));
    if(!obj || obj.v !== SAVE_VER) throw new Error("ç‰ˆæœ¬ä¸ç›¸å®¹");
    return obj;
  }

  // =========================
  // HELPERS
  // =========================
  function curZone(){ return ZONES[clamp(S.zoneIdx, 0, ZONES.length-1)]; }
  function nextZone(){ return ZONES[S.zoneIdx + 1] || null; }
  function bagCount(){ return S.bag.reduce((a,x)=>a+x.q, 0); }
  function bagHasSpace(n){ return bagCount() + n <= S.bagCap; }

  function fishById(id){
    for(const z of ZONES){
      const f = z.fish.find(x => x.id === id);
      if(f) return f;
    }
    return null;
  }
  function priceOfFish(fish){
    const r = RAR[fish.rar] || RAR.C;
    const zoneMult = 1 + (S.zoneIdx * 0.18);
    return Math.round(fish.base * r.mult * zoneMult);
  }

  function weightedPick(list){
    const total = list.reduce((a,x)=>a + x.w, 0);
    let r = Math.random() * total;
    for(const x of list){
      r -= x.w;
      if(r <= 0) return x;
    }
    return list[list.length-1];
  }

  function rodQualityBonus(){ return Math.min(0.55, (S.rodLv - 1) * 0.035); }

  function makeZoneFishTable(){
    const z = curZone();
    const q = rodQualityBonus();
    return z.fish.map(f => {
      let w = f.w;
      if(f.rar==="U") w *= (1 + q * 0.9);
      if(f.rar==="R") w *= (1 + q * 1.4);
      if(f.rar==="E") w *= (1 + q * 2.0);
      if(f.rar==="L") w *= (1 + q * 2.6);
      if(f.rar==="C") w *= (1 - q * 0.35);
      return {...f, w: Math.max(0.2, w)};
    });
  }

  function addToBag(fishId, qty){
    const it = S.bag.find(x => x.id === fishId);
    if(it) it.q += qty;
    else S.bag.push({id: fishId, q: qty});
  }

  // ä¸€è¼ªç”¢å‡ºï¼š1~2 æ¢ï¼ˆç¯€å¥æ›´åƒæ”¾ç½®ï¼Œä¸æœƒçˆ†å€‰çˆ†åˆ°æ²’äººæƒ³ç©ï¼‰
  function planCatch(){
    const extraChance = clamp((S.rodLv-1) * 0.08, 0, 0.35);
    let n = 1;
    if(Math.random() < extraChance) n += 1;
    n = clamp(n, 1, 2);

    const table = makeZoneFishTable();
    const planned = [];
    for(let i=0;i<n;i++){
      const f = weightedPick(table);
      planned.push({id:f.id, q:1});
    }
    return planned;
  }

  // æ´¾é£æ¯è¼ªç§’æ•¸ï¼šé‡£ç«¿æœƒç¸®çŸ­ï¼Œä½†æœ‰ä¸‹é™é¿å…ç˜‹ç‹‚çˆ†é‡
  function cycleSec(){
    const base = curZone().baseCycleSec;
    const factor = Math.pow(0.96, S.rodLv - 1);
    return Math.max(35, Math.round(base * factor)); // âœ… ä¸‹é™ 35sï¼Œé¿å…åˆå›åˆ° 18s åœ°ç„
  }

  function sellAll(){
    const cnt = bagCount();
    if(cnt <= 0) return 0;
    let gold = 0;
    for(const it of S.bag){
      const f = fishById(it.id);
      if(!f) continue;
      gold += priceOfFish(f) * it.q;
    }
    S.bag = [];
    S.gold += gold;
    S.totalGold += gold;
    S.totalSold += cnt;

    // daily
    S.meta.daily.sell += cnt;

    return gold;
  }

  // âœ… æ–°é­šçå‹µï¼šè§£é–æ–°åœ–é‘‘å°±çµ¦å° bonusï¼ˆè®“æ”¶é›†æœ‰çˆ½é»ï¼‰
  function awardNewDex(fishId){
    if(S.dex[fishId]) return;
    S.dex[fishId] = true;

    const f = fishById(fishId);
    const bonus = f ? Math.max(8, Math.round(priceOfFish(f) * 0.9)) : 10;
    S.gold += bonus;
    S.totalGold += bonus;

    S.meta.daily.newDex += 1;
    pushLog(`ğŸ†• è§£é–åœ–é‘‘ï¼š${f ? f.name : fishId}ã€€+${bonus}`);
    showToast(`æ–°é­š +${bonus}`, 900);
  }

  // âœ… ä¸€è¼ªåŸ·è¡Œï¼šå…¥èƒŒåŒ…ï¼›æ»¿äº†å°± autoSell or pause
  function runOneCycle(){
    const got = planCatch();
    const need = got.length;

    if(!bagHasSpace(need)){
      if(S.settings.autoSell){
        const g = sellAll();
        if(g > 0) pushLog(`ğŸ’° è‡ªå‹•è³£å‡º +${g}`);
      }else{
        S.dispatch.active = false;
        pushLog(`â¸ èƒŒåŒ…æ»¿ï¼ˆå·²æš«åœï¼‰`);
        showToast(`<b>èƒŒåŒ…æ»¿</b>ï¼ˆå·²æš«åœï¼‰`, 1100);
        return;
      }
    }

    if(!bagHasSpace(need)){
      S.dispatch.active = false;
      pushLog(`â¸ èƒŒåŒ…æ»¿ï¼ˆå·²æš«åœï¼‰`);
      return;
    }

    for(const p of got){
      addToBag(p.id, p.q);
      awardNewDex(p.id);
    }
    S.totalCatch += got.length;
    S.meta.daily.catch += got.length;
    S.dispatch.lastCycleOut = got.length;
  }

  function startDispatch(){
    if(S.dispatch.active){
      showToast(`å·²åœ¨æ´¾é£`, 800);
      return;
    }
    const mins = S.settings.dispatchMin || 15;
    const t0 = now();
    const csec = cycleSec();
    S.dispatch = {
      active: true,
      startAt: t0,
      endAt: t0 + mins*60*1000,
      zoneIdx: S.zoneIdx,
      cycleSec: csec,
      nextTickAt: t0 + csec*1000,
      lastCycleOut: 0
    };
    pushLog(`â–¶ æ´¾é£é–‹å§‹ï¼ˆ${mins}åˆ†ï¼‰`);
    showToast(`æ´¾é£é–‹å§‹`, 800);
    saveLocal();
    renderAll();
  }

  function stopDispatch(){
    if(!S.dispatch.active){
      showToast(`æœªæ´¾é£`, 700);
      return;
    }
    S.dispatch.active = false;
    pushLog(`â–  æ´¾é£åœæ­¢`);
    showToast(`å·²åœæ­¢`, 800);
    saveLocal();
    renderAll();
  }

  // é›¢ç·šè£œç®—
  function applyOffline(){
    if(!S.dispatch || !S.dispatch.startAt) return;

    const t = now();
    const capEnd = S.dispatch.active ? Math.min(t, S.dispatch.endAt) : Math.min(t, S.dispatch.endAt || t);
    if(capEnd <= S.dispatch.startAt) return;

    let cycles = 0;
    let next = S.dispatch.nextTickAt || (S.dispatch.startAt + (S.dispatch.cycleSec||cycleSec())*1000);

    const maxCycles = 2000;
    while(next <= capEnd && cycles < maxCycles){
      runOneCycle();
      cycles++;
      next += (S.dispatch.cycleSec || cycleSec()) * 1000;
      if(!S.dispatch.active && !S.settings.autoSell) break;
    }

    S.dispatch.nextTickAt = next;

    if(S.dispatch.active && t >= S.dispatch.endAt){
      S.dispatch.active = false;
      pushLog(`â–  æ´¾é£å®Œæˆ`);
      showToast(`æ´¾é£å®Œæˆ`, 900);
    }

    if(cycles > 0){
      pushLog(`â± é›¢ç·šè£œç®— ${cycles} è¼ª`);
    }
  }

  // =========================
  // UPGRADES
  // =========================
  function rodUpCost(){
    const lv = S.rodLv;
    return Math.round(180 * Math.pow(1.55, lv-1));
  }
  function upgradeRod(){
    const cost = rodUpCost();
    if(S.gold < cost){ showToast(`é‡‘å¹£ä¸è¶³`, 900); return; }
    S.gold -= cost;
    S.rodLv += 1;
    pushLog(`â¬†ï¸ é‡£ç«¿ Lv${S.rodLv}`);
    if(S.dispatch.active){
      S.dispatch.cycleSec = cycleSec(); // ä¸‹ä¸€è¼ªç¯€å¥æ›´æ–°
    }
    saveLocal();
    renderAll();
  }

  // âœ… èƒŒåŒ…æ“´å……ï¼šæ¯æ¬¡ +15 æ ¼ï¼Œä¸Šé™ 180ï¼ˆä½ è¦æ›´å¤§ä¹Ÿè¡Œï¼‰
  function refreshBagCap(){
    S.bagCap = 30 + S.bagLv * 15;
    S.bagCap = clamp(S.bagCap, 30, 180);
  }
  function bagUpCost(){
    // å‰æœŸä¾¿å®œï¼Œå¾ŒæœŸæ¼²ï¼Œé¿å…é€šè†¨å¤ªç„¡è…¦
    return Math.round(220 * Math.pow(1.48, S.bagLv));
  }
  function upgradeBag(){
    refreshBagCap();
    if(S.bagCap >= 180){ showToast(`èƒŒåŒ…å·²æ»¿ç´š`, 900); return; }
    const cost = bagUpCost();
    if(S.gold < cost){ showToast(`é‡‘å¹£ä¸è¶³`, 900); return; }
    S.gold -= cost;
    S.bagLv += 1;
    refreshBagCap();
    pushLog(`ğŸ’ èƒŒåŒ…æ“´å……åˆ° ${S.bagCap}`);
    showToast(`èƒŒåŒ… +15`, 800);
    saveLocal();
    renderAll();
  }

  function unlockNextZone(){
    const nz = nextZone();
    if(!nz){ showToast(`ç„¡ä¸‹ä¸€æ°´åŸŸ`, 900); return; }
    if(S.dispatch.active){ showToast(`æ´¾é£ä¸­ä¸å¯åˆ‡æ°´åŸŸ`, 1100); return; }
    if(S.gold < nz.unlockGold){ showToast(`é‡‘å¹£ä¸è¶³`, 900); return; }
    S.gold -= nz.unlockGold;
    S.zoneIdx += 1;
    pushLog(`ğŸŒŠ è§£é– ${curZone().name}`);
    saveLocal();
    renderAll();
  }

  // =========================
  // DAILY + ACHIEVEMENTS
  // =========================
  function ensureDaily(){
    const k = todayKey();
    if(!S.meta) S.meta = defaultState().meta;
    if(S.meta.dailyKey !== k){
      S.meta.dailyKey = k;
      S.meta.daily = { catch:0, sell:0, newDex:0, claim:{} };
      pushLog(`ğŸ“… æ¯æ—¥ä»»å‹™å·²é‡ç½®`);
    }
    if(!S.meta.achClaim) S.meta.achClaim = {};
  }

  function dailyDefs(){
    return [
      { id:"d_catch",  title:"ä»Šæ—¥é‡£åˆ° 25 æ¢",  desc:`é€²åº¦ï¼š${S.meta.daily.catch}/25`, ok: S.meta.daily.catch >= 25, reward: 180 },
      { id:"d_sell",   title:"ä»Šæ—¥è³£å‡º 20 æ¢",  desc:`é€²åº¦ï¼š${S.meta.daily.sell}/20`,  ok: S.meta.daily.sell >= 20,  reward: 220 },
      { id:"d_newdex", title:"ä»Šæ—¥è§£é– 1 ç¨®æ–°é­š", desc:`é€²åº¦ï¼š${S.meta.daily.newDex}/1`, ok: S.meta.daily.newDex >= 1, reward: 260 },
    ];
  }

  function achDefs(){
    const dexCount = Object.keys(S.dex||{}).length;
    return [
      { id:"a_rod5", title:"é‡£ç«¿å‡åˆ° Lv5",   desc:`ç›®å‰ï¼šLv${S.rodLv}`, ok: S.rodLv >= 5, reward: 600 },
      { id:"a_lake", title:"è§£é–æ·±æ¹–",       desc:`ç›®å‰æ°´åŸŸï¼š${curZone().name}`, ok: S.zoneIdx >= 2, reward: 900 },
      { id:"a_bag60",title:"èƒŒåŒ…æ“´å……åˆ° 60",  desc:`ç›®å‰å®¹é‡ï¼š${S.bagCap}`, ok: S.bagCap >= 60, reward: 500 },
      { id:"a_dex10",title:"åœ–é‘‘è’é›† 10 ç¨®", desc:`ç›®å‰ï¼š${dexCount}/10`, ok: dexCount >= 10, reward: 700 },
    ];
  }

  function claimDaily(id){
    ensureDaily();
    const def = dailyDefs().find(x => x.id === id);
    if(!def) return;
    if(!def.ok){ showToast(`æœªé”æˆ`, 800); return; }
    if(S.meta.daily.claim[id]){ showToast(`å·²é ˜é`, 800); return; }
    S.meta.daily.claim[id] = true;
    S.gold += def.reward;
    S.totalGold += def.reward;
    pushLog(`ğŸ æ¯æ—¥çå‹µï¼š+${def.reward}`);
    showToast(`+${def.reward}`, 900);
    saveLocal();
    renderAll();
    renderQuest();
  }

  function claimAch(id){
    ensureDaily();
    const def = achDefs().find(x => x.id === id);
    if(!def) return;
    if(!def.ok){ showToast(`æœªé”æˆ`, 800); return; }
    if(S.meta.achClaim[id]){ showToast(`å·²é ˜é`, 800); return; }
    S.meta.achClaim[id] = true;
    S.gold += def.reward;
    S.totalGold += def.reward;
    pushLog(`ğŸ† æˆå°±çå‹µï¼š+${def.reward}`);
    showToast(`+${def.reward}`, 900);
    saveLocal();
    renderAll();
    renderQuest();
  }

  // =========================
  // RENDER
  // =========================
  function renderHeader(){
    refreshBagCap();
    $("gold").textContent = fmtInt(S.gold);
    $("rodLv").textContent = S.rodLv;
    $("zoneName").textContent = curZone().name;

    const bc = bagCount();
    $("bagStat").textContent = `${bc}/${S.bagCap}`;
    $("bag2").textContent = bc;
    $("bagCap2").textContent = S.bagCap;

    const dexCount = Object.keys(S.dex||{}).length;
    $("dex2").textContent = dexCount;
    $("dexAll2").textContent = ALL_FISH_IDS.length;

    $("totalCatch").textContent = fmtInt(S.totalCatch);
    $("totalSold").textContent = fmtInt(S.totalSold);
    $("totalGold").textContent = fmtInt(S.totalGold);

    $("rodCost").textContent = rodUpCost();
    $("bagCost").textContent = (S.bagCap >= 180) ? "â€”" : bagUpCost();
    $("zoneCost").textContent = nextZone() ? nextZone().unlockGold : "â€”";

    $("autoSellView").textContent = S.settings.autoSell ? "é–‹" : "é—œ";
    $("cycleOut").textContent = S.dispatch.lastCycleOut ? `${S.dispatch.lastCycleOut}æ¢` : "â€”";
    $("cycleSecView").textContent = `${cycleSec()} ç§’/è¼ª`;
  }

  function renderStatus(){
    const prog = $("prog");
    if(!S.dispatch.active){
      $("status").textContent = "å¾…å‘½";
      $("remain").textContent = "â€”";
      prog.style.width = "0%";
      return;
    }
    $("status").textContent = "æ´¾é£ä¸­";
    const t = now();
    const r = Math.max(0, S.dispatch.endAt - t);
    $("remain").textContent = `${Math.ceil(r/1000)}s`;

    const cycle = (S.dispatch.cycleSec || cycleSec()) * 1000;
    const next = S.dispatch.nextTickAt || (t + cycle);
    const elapsed = clamp(cycle - Math.max(0, next - t), 0, cycle);
    const pct = cycle ? (elapsed / cycle) * 100 : 0;
    prog.style.width = `${pct.toFixed(1)}%`;
  }

  function renderLog(){
    const box = $("log");
    box.innerHTML = "";
    if(!S.log.length){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logM" style="color:var(--muted); font-weight:800;">å°šç„¡ç´€éŒ„</div>`;
      box.appendChild(div);
      return;
    }
    for(const it of S.log){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logT">${it.t}</div><div class="logM">${it.msg}</div>`;
      box.appendChild(div);
    }
  }

  function renderBagDialog(){
    const box = $("bagList");
    box.innerHTML = "";

    const bagSorted = [...S.bag].sort((a,b)=>a.id.localeCompare(b.id));
    if(!bagSorted.length){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logM" style="color:var(--muted); font-weight:800;">èƒŒåŒ…ç©º</div>`;
      box.appendChild(div);
    }else{
      for(const it of bagSorted){
        const f = fishById(it.id);
        const rar = f ? (RAR[f.rar]?.name || f.rar) : "æœªçŸ¥";
        const price = f ? priceOfFish(f) : 0;
        const div = document.createElement("div");
        div.className = "logItem";
        div.innerHTML = `<div class="logM">${f ? f.name : it.id}ï¼ˆ${rar}ï¼‰x${it.q}ã€€å–®åƒ¹${price}ã€€å°è¨ˆ${price*it.q}</div>`;
        box.appendChild(div);
      }
    }

    const div2 = document.createElement("div");
    div2.className = "logItem";
    div2.innerHTML = `<div class="logT">åœ–é‘‘</div>`;
    box.appendChild(div2);

    const dexWrap = document.createElement("div");
    dexWrap.style.display = "flex";
    dexWrap.style.flexWrap = "wrap";
    dexWrap.style.gap = "8px";
    dexWrap.style.padding = "8px 6px 2px";
    for(const id of ALL_FISH_IDS){
      const f = fishById(id);
      const ok = !!S.dex[id];
      const chip = document.createElement("div");
      chip.className = "pill";
      chip.style.opacity = ok ? "1" : "0.55";
      chip.style.padding = "8px 10px";
      chip.textContent = `${ok ? "âœ…" : "â€”"} ${f ? f.name : id}`;
      dexWrap.appendChild(chip);
    }
    box.appendChild(dexWrap);
  }

  function renderQuest(){
    ensureDaily();

    const dbox = $("dailyList");
    dbox.innerHTML = "";
    for(const d of dailyDefs()){
      const claimed = !!S.meta.daily.claim[d.id];
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML =
        `<div class="logM">${d.ok ? "âœ…" : "â€”"} ${d.title}</div>
         <div class="logT">${d.desc}ã€€ï½œã€€çå‹µ +${d.reward}ã€€${claimed ? "ï¼ˆå·²é ˜ï¼‰" : ""}</div>
         <div class="row" style="margin-top:8px;">
           <button class="btn primary" data-claim-d="${d.id}" ${(!d.ok || claimed) ? "disabled" : ""}>é ˜å–</button>
         </div>`;
      dbox.appendChild(div);
    }
    dbox.querySelectorAll("[data-claim-d]").forEach(btn=>{
      btn.addEventListener("click", ()=> claimDaily(btn.dataset.claimD));
    });

    const abox = $("achList");
    abox.innerHTML = "";
    for(const a of achDefs()){
      const claimed = !!S.meta.achClaim[a.id];
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML =
        `<div class="logM">${a.ok ? "ğŸ†" : "â€”"} ${a.title}</div>
         <div class="logT">${a.desc}ã€€ï½œã€€çå‹µ +${a.reward}ã€€${claimed ? "ï¼ˆå·²é ˜ï¼‰" : ""}</div>
         <div class="row" style="margin-top:8px;">
           <button class="btn primary" data-claim-a="${a.id}" ${(!a.ok || claimed) ? "disabled" : ""}>é ˜å–</button>
         </div>`;
      abox.appendChild(div);
    }
    abox.querySelectorAll("[data-claim-a]").forEach(btn=>{
      btn.addEventListener("click", ()=> claimAch(btn.dataset.claimA));
    });
  }

  function renderAll(){
    renderHeader();
    renderStatus();
    renderLog();
  }

  // æ¯ç§’ tick
  function tick(){
    const t = now();

    if(S.dispatch.active){
      if(t >= S.dispatch.endAt){
        S.dispatch.active = false;
        pushLog(`â–  æ´¾é£å®Œæˆ`);
        showToast(`æ´¾é£å®Œæˆ`, 900);
      }
      while(S.dispatch.active && S.dispatch.nextTickAt && t >= S.dispatch.nextTickAt){
        runOneCycle();
        S.dispatch.nextTickAt += (S.dispatch.cycleSec || cycleSec()) * 1000;
      }
    }

    ensureDaily();
    renderAll();
    saveLocal();
  }

  // =========================
  // UI EVENTS
  // =========================

  // Control dialog
  const dlgCtrl = $("dlgCtrl");
  $("ctrlBtn").addEventListener("click", () => dlgCtrl.showModal());
  $("closeCtrl").addEventListener("click", () => dlgCtrl.close());

  // duration segment
  function setDispatchMin(min){
    S.settings.dispatchMin = min;
    document.querySelectorAll("#durSeg button").forEach(b => {
      b.classList.toggle("active", Number(b.dataset.min) === min);
    });
    saveLocal();
  }
  document.querySelectorAll("#durSeg button").forEach(b => {
    b.addEventListener("click", () => setDispatchMin(Number(b.dataset.min)));
  });

  // autoSell toggle
  const autoSell = $("autoSell");
  autoSell.addEventListener("change", () => {
    S.settings.autoSell = !!autoSell.checked;
    $("autoSellView").textContent = S.settings.autoSell ? "é–‹" : "é—œ";
    saveLocal();
  });

  $("startBtn").addEventListener("click", () => startDispatch());
  $("stopBtn").addEventListener("click", () => stopDispatch());
  $("sellBtn").addEventListener("click", () => {
    const g = sellAll();
    if(g > 0){
      pushLog(`ğŸ’° è³£å…‰ +${g}`);
      showToast(`+${g}`, 900);
    }else{
      showToast(`èƒŒåŒ…ç©º`, 700);
    }
    saveLocal();
    renderAll();
    renderQuest();
  });

  // Save dialog
  const dlgSave = $("dlgSave");
  $("saveBtn").addEventListener("click", () => {
    $("saveText").value = exportCode();
    dlgSave.showModal();
  });
  $("closeSave").addEventListener("click", () => dlgSave.close());
  $("btnExport").addEventListener("click", () => {
    $("saveText").value = exportCode();
    showToast(`å·²åŒ¯å‡º`, 700);
  });
  $("btnCopy").addEventListener("click", async () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`ç©º`, 700); return; }
    try{
      await navigator.clipboard.writeText(txt);
      showToast(`å·²è¤‡è£½`, 700);
    }catch(_){
      $("saveText").focus();
      $("saveText").select();
      showToast(`å·²é¸å–`, 900);
    }
  });
  $("btnImport").addEventListener("click", () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`è«‹è²¼ä¸Š`, 850); return; }
    try{
      S = importCode(txt);
      // å…¼å®¹ï¼šè£œç¼ºæ¬„ä½
      if(!S.meta) S.meta = defaultState().meta;
      if(!S.bagLv && S.bagLv !== 0) S.bagLv = 0;
      refreshBagCap();
      saveLocal();
      applyOffline();
      renderAll();
      renderQuest();
      pushLog(`ğŸ“¥ åŒ¯å…¥`);
      showToast(`åŒ¯å…¥æˆåŠŸ`, 800);
    }catch(_){
      showToast(`åŒ¯å…¥å¤±æ•—`, 1000);
    }
  });
  $("btnReset").addEventListener("click", () => {
    S = defaultState();
    saveLocal();
    renderAll();
    renderQuest();
    pushLog(`ğŸ§¨ é‡ç½®`);
    showToast(`å·²é‡ç½®`, 800);
  });

  // Bag dialog
  const dlgBag = $("dlgBag");
  $("bagBtn").addEventListener("click", () => {
    renderBagDialog();
    dlgBag.showModal();
  });
  $("closeBag").addEventListener("click", () => dlgBag.close());

  // Quest dialog
  const dlgQuest = $("dlgQuest");
  $("questBtn").addEventListener("click", () => {
    renderQuest();
    dlgQuest.showModal();
  });
  $("closeQuest").addEventListener("click", () => dlgQuest.close());

  // Upgrades / zone
  $("rodUpBtn").addEventListener("click", () => upgradeRod());
  $("bagUpBtn").addEventListener("click", () => upgradeBag());
  $("zoneUpBtn").addEventListener("click", () => unlockNextZone());

  // boot
  function boot(){
    S = loadLocal() || defaultState();

    // æ¬„ä½è£œé½Šï¼ˆé¿å…ä½ èˆŠæª”åŒ¯å…¥/èˆŠ localStorage ç‚¸è£‚ï¼‰
    if(!S.v) S.v = SAVE_VER;
    if(!S.dex) S.dex = {};
    if(!Array.isArray(S.bag)) S.bag = [];
    if(!Array.isArray(S.log)) S.log = [];
    if(!S.settings) S.settings = { autoSell:true, dispatchMin:15 };
    if(!S.dispatch) S.dispatch = defaultState().dispatch;
    if(!S.meta) S.meta = defaultState().meta;
    if(!S.bagLv && S.bagLv !== 0) S.bagLv = 0;
    refreshBagCap();

    ensureDaily();

    // UI sync
    autoSell.checked = !!S.settings.autoSell;
    setDispatchMin(S.settings.dispatchMin || 15);

    applyOffline();
    renderAll();
    renderQuest();

    setInterval(tick, 1000);
  }
  boot();
})();
</script>
</body>
</html>