<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>æ”¾ç½®é‡£é­š</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Fishing" />

  <link rel="manifest" href="/game/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/game/icons/icon-192.png">

  <style>
    :root{
      color-scheme: dark light;
      --homebar: max(env(safe-area-inset-bottom), 34px);
      --maxw: 900px;
    }

    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:#121b2e;
      --card2:#0f1728;
      --border:rgba(255,255,255,.10);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.72);
      --btn:#1b2640;
      --btn2:#223155;
      --accent:#57b8ff;
      --good:#7cf7b6;
      --warn:#ffcc66;
      --bad:#ff668a;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#f0f3fb;
      --border:rgba(0,0,0,.10);
      --text:#0b1220;
      --muted:rgba(11,18,32,.70);
      --btn:#ffffff;
      --btn2:#eef2fb;
      --accent:#1e79c8;
      --good:#1ea972;
      --warn:#d9822b;
      --bad:#d23a5a;
    }

    html, body{
      margin:0; height:100%;
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
    }
    body{ position:fixed; inset:0; }

    .app{
      height:100svh;
      padding-top: calc(env(safe-area-inset-top) + 12px);
      padding-left: calc(env(safe-area-inset-left) + 12px);
      padding-right: calc(env(safe-area-inset-right) + 12px);
      padding-bottom: calc(var(--homebar) + 12px);
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:min(var(--maxw), 96vw);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .top .left, .top .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      font-weight:900;
      min-height:46px;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
    }
    .btn:active{ transform:scale(.985); }
    .btn.primary{
      background:var(--btn2);
      border-color: color-mix(in oklab, var(--accent), var(--border) 60%);
    }

    .stat{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      font-weight:900;
      white-space:nowrap;
    }
    .stat b{ color:var(--accent); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:12px;
      min-height:0;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:16px;
      padding:14px;
      min-height:0;
    }
    .card h2{ margin:0 0 8px; font-size:16px; letter-spacing:.2px; }
    .sub{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.45; }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    @media (max-width: 420px){
      .kpi{ grid-template-columns:1fr; }
    }
    .kpiBox{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:14px;
      padding:12px;
    }
    .kpiBox .label{ font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:800; }
    .kpiBox .value{ font-size:18px; font-weight:1000; }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .actions{ grid-template-columns:1fr; }
    }

    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    .pill{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
    }
    .pill b{ color:var(--accent); }

    .list{
      border:1px solid var(--border);
      background:var(--card2);
      border-radius:14px;
      padding:10px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height: 52svh;
    }
    .logItem{
      border-bottom:1px solid var(--border);
      padding:10px 6px;
    }
    .logItem:last-child{ border-bottom:none; }
    .logT{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      font-weight:800;
    }
    .logM{
      font-size:14px;
      font-weight:900;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      top: calc(env(safe-area-inset-top) + 10px);
      transform:translateX(-50%);
      z-index:999;
      border:1px solid var(--border);
      background:var(--card);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:1000;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(6px); }
    .toast b{ color:var(--accent); }

    dialog{
      width:min(860px, 94vw);
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
      padding:0;
    }
    dialog::backdrop{ background: rgba(0,0,0,.35); }
    .dlgHead{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dlgHead h3{ margin:0; font-size:15px; }
    .dlgBody{ padding:14px; display:flex; flex-direction:column; gap:10px; }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:12px;
      font-size:13px;
      line-height:1.4;
      outline:none;
    }
    .dlgFoot{
      padding:14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="wrap">
      <div class="top">
        <div class="left">
          <button class="btn" id="backBtn">â† Back</button>
          <button class="btn primary" id="themeBtn">ä¸»é¡Œï¼šæ·±è‰²</button>
          <button class="btn" id="saveBtn">å­˜æª”ç¢¼</button>
          <button class="btn" id="bagBtn">èƒŒåŒ…/åœ–é‘‘</button>
        </div>
        <div class="right">
          <div class="stat">é‡‘å¹£ï¼š<b id="gold">0</b></div>
          <div class="stat">é‡£ç«¿ï¼šLv <b id="rodLv">1</b></div>
          <div class="stat">æ°´åŸŸï¼š<b id="zoneName">æ–°æ‰‹æ± </b></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>é‡£é­šä½œæ¥­é¢æ¿</h2>
          <p class="sub">æ´¾é£ â†’ ç­‰å¾… â†’ çµç®— â†’ è³£é­šå‡ç´šã€‚é›¢ç·šä¹Ÿæœƒç®—ã€‚</p>

          <div class="kpi">
            <div class="kpiBox">
              <div class="label">ç‹€æ…‹</div>
              <div class="value" id="status">å¾…å‘½</div>
            </div>
            <div class="kpiBox">
              <div class="label">å‰©é¤˜</div>
              <div class="value" id="remain">â€”</div>
            </div>
            <div class="kpiBox">
              <div class="label">èƒŒåŒ…</div>
              <div class="value"><span id="bag">0</span>/<span id="bagCap">30</span></div>
            </div>
            <div class="kpiBox">
              <div class="label">é­šåœ–é‘‘</div>
              <div class="value"><span id="dex">0</span>/<span id="dexAll">0</span></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="castBtn">ğŸ£ é–‹å§‹é‡£é­š</button>
            <button class="btn primary" id="claimBtn">âœ… çµç®—æ”¶é­š</button>
            <button class="btn" id="sellBtn">ğŸ’° å…¨éƒ¨è³£æ‰</button>
            <button class="btn" id="helpBtn">â“ èªªæ˜</button>
          </div>

          <div class="card" style="margin-top:12px; background:var(--card2);">
            <h2 style="margin:0 0 10px; font-size:15px;">å‡ç´šèˆ‡è§£é–</h2>
            <div class="miniRow">
              <div class="pill">é‡£ç«¿å‡ç´šè²»ï¼š<b id="rodCost">â€”</b></div>
              <button class="btn primary" id="rodUpBtn">â¬†ï¸ å‡ç´šé‡£ç«¿</button>
              <div class="pill">æ°´åŸŸè§£é–è²»ï¼š<b id="zoneCost">â€”</b></div>
              <button class="btn primary" id="zoneUpBtn">ğŸŒŠ è§£é–ä¸‹ä¸€æ°´åŸŸ</button>
            </div>
            <p class="sub" style="margin:10px 0 0;">
              é‡£ç«¿ï¼šç¸®çŸ­ç­‰å¾…ã€ç•¥æå‡ç¨€æœ‰ã€‚æ°´åŸŸï¼šé­šç¨®èˆ‡åƒ¹æ ¼ä¸Šé™æ›´é«˜ã€‚
            </p>
          </div>
        </div>

        <div class="card">
          <h2>ä½œæ¥­ç´€éŒ„</h2>
          <p class="sub">ä½ ä¸æ˜¯åœ¨é‡£é­šï¼Œä½ æ˜¯åœ¨è·‘ä¸€å€‹éš¨æ©Ÿç”¢å‡ºæµç¨‹ï¼ˆå¾ˆä¼æ¥­ï¼Œèˆ’æœï¼‰ã€‚</p>

          <div class="list" id="log"></div>

          <div class="miniRow">
            <div class="pill">ç¸½é‡£ç²ï¼š<b id="totalCatch">0</b></div>
            <div class="pill">ç¸½è³£å‡ºï¼š<b id="totalSold">0</b></div>
            <div class="pill">ç´¯ç©é‡‘å¹£ï¼š<b id="totalGold">0</b></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å­˜æª”ç¢¼ -->
  <dialog id="dlgSave">
    <div class="dlgHead">
      <h3>å­˜æª”ç¢¼ï¼ˆé˜²æ¸…é™¤/å¯æ›æ©Ÿï¼‰</h3>
      <button class="btn" id="closeSave">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="sub" style="margin:0;">
        æœ¬æ©Ÿæœƒè‡ªå‹•å­˜ï¼Œä½†ä½ æ¸… Safari ç¶²ç«™è³‡æ–™å°±æœƒæ²’ã€‚å­˜æª”ç¢¼æ˜¯ä½ çš„å‚™æ´ã€‚
      </div>
      <textarea id="saveText" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºå­˜æª”ç¢¼â€¦"></textarea>
      <div class="miniRow">
        <button class="btn primary" id="btnExport">åŒ¯å‡º</button>
        <button class="btn" id="btnCopy">è¤‡è£½</button>
        <button class="btn primary" id="btnImport">åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
        <button class="btn" id="btnReset">é‡ç½®</button>
      </div>
    </div>
    <div class="dlgFoot">
      <button class="btn primary" id="closeSave2">OK</button>
    </div>
  </dialog>

  <!-- èƒŒåŒ… -->
  <dialog id="dlgBag">
    <div class="dlgHead">
      <h3>èƒŒåŒ… / åœ–é‘‘</h3>
      <button class="btn" id="closeBag">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="miniRow">
        <div class="pill">èƒŒåŒ…ï¼š<b id="bag2">0</b>/<b id="bagCap2">30</b></div>
        <div class="pill">åœ–é‘‘ï¼š<b id="dex2">0</b>/<b id="dexAll2">0</b></div>
      </div>
      <div class="list" id="bagList" style="max-height:56svh;"></div>
    </div>
    <div class="dlgFoot">
      <button class="btn primary" id="closeBag2">OK</button>
    </div>
  </dialog>

  <!-- èªªæ˜ -->
  <dialog id="dlgHelp">
    <div class="dlgHead">
      <h3>ç©æ³•èªªæ˜</h3>
      <button class="btn" id="closeHelp">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="sub" style="margin:0;">
        1) æŒ‰ã€Œé–‹å§‹é‡£é­šã€æ´¾é£ã€‚<br>
        2) æ™‚é–“åˆ°å¾ŒæŒ‰ã€Œçµç®—æ”¶é­šã€ã€‚<br>
        3) èƒŒåŒ…æ»¿äº†å°±ã€Œå…¨éƒ¨è³£æ‰ã€æ›é‡‘å¹£ã€‚<br>
        4) å‡ç´šé‡£ç«¿ç¸®çŸ­æ™‚é–“ã€ç•¥æé«˜ç¨€æœ‰ï¼›è§£é–æ°´åŸŸæé«˜åƒ¹å€¼èˆ‡é­šç¨®ã€‚<br>
        5) æ“”å¿ƒæ¸…é™¤è³‡æ–™ï¼šå»ã€Œå­˜æª”ç¢¼ã€åŒ¯å‡ºå‚™ä»½ã€‚
      </div>
    </div>
    <div class="dlgFoot">
      <button class="btn primary" id="closeHelp2">OK</button>
    </div>
  </dialog>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
  const fmt = (n) => (Math.floor(n) === n ? String(n) : n.toFixed(2));
  const now = () => Date.now();

  const toast = $("toast");
  let toastTimer = 0;
  function showToast(msg, ms=900){
    toast.innerHTML = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
  }

  // Theme
  const THEME_KEY = "idle_fishing_theme_clean_v1";
  function systemTheme(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
  }
  function applyTheme(mode){
    const final = (mode === "system") ? systemTheme() : mode;
    document.documentElement.dataset.theme = final;
    const meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute("content", final === "light" ? "#f6f7fb" : "#0b1220");
    $("themeBtn").textContent = `ä¸»é¡Œï¼š${final === "light" ? "æ·ºè‰²" : "æ·±è‰²"}`;
  }
  function getThemeMode(){ return localStorage.getItem(THEME_KEY) || "system"; }
  function setThemeMode(mode){ localStorage.setItem(THEME_KEY, mode); applyTheme(mode); }
  applyTheme(getThemeMode());
  if(window.matchMedia){
    window.matchMedia("(prefers-color-scheme: light)").addEventListener?.("change", () => {
      if(getThemeMode() === "system") applyTheme("system");
    });
  }
  $("themeBtn").addEventListener("click", () => {
    const cur = document.documentElement.dataset.theme;
    setThemeMode(cur === "light" ? "dark" : "light");
  });

  // Back
  $("backBtn").addEventListener("click", () => {
    const hub = "/game/";
    try{
      if(document.referrer && document.referrer.includes("/game/")) history.back();
      else location.href = hub;
    }catch(_){
      location.href = hub;
    }
  });

  // Data
  const RAR = {
    C: {name:"æ™®é€š", mult:1.0},
    U: {name:"å°‘è¦‹", mult:1.6},
    R: {name:"ç¨€æœ‰", mult:2.6},
    E: {name:"å²è©©", mult:4.2},
    L: {name:"å‚³èªª", mult:7.0},
  };

  const ZONES = [
    { id:"pond", name:"æ–°æ‰‹æ± ", unlockGold:0, baseTimeSec:18,
      fish:[
        {id:"minnow",  name:"å°éŠ€é­š", base: 6,  rar:"C", w:60},
        {id:"carp",    name:"é¯‰é­š",   base:10,  rar:"C", w:45},
        {id:"catfish", name:"é¯°é­š",   base:16,  rar:"U", w:24},
        {id:"eel",     name:"é°»é­š",   base:22,  rar:"R", w:10},
        {id:"koi",     name:"éŒ¦é¯‰",   base:40,  rar:"E", w:4},
      ]},
    { id:"river", name:"æºªæµ", unlockGold:600, baseTimeSec:24,
      fish:[
        {id:"trout",   name:"é±’é­š",   base:18,  rar:"C", w:55},
        {id:"bass",    name:"é±¸é­š",   base:26,  rar:"U", w:28},
        {id:"pike",    name:"ç‹—é­š",   base:38,  rar:"R", w:12},
        {id:"golden",  name:"é‡‘é±—é­š", base:60,  rar:"E", w:4},
        {id:"spirit",  name:"éˆæ°´é­š", base:95,  rar:"L", w:1},
      ]},
    { id:"lake", name:"æ·±æ¹–", unlockGold:2600, baseTimeSec:30,
      fish:[
        {id:"perch",    name:"æ²³é±¸",   base:28,  rar:"C", w:52},
        {id:"tilapia",  name:"å³éƒ­é­š", base:34,  rar:"U", w:30},
        {id:"sturgeon", name:"é±˜é­š",   base:70,  rar:"R", w:12},
        {id:"moon",     name:"æœˆå½±é­š", base:120, rar:"E", w:5},
        {id:"ancient",  name:"å¤ä»£é­š", base:180, rar:"L", w:1},
      ]},
  ];

  const ALL_FISH_IDS = Array.from(new Set(ZONES.flatMap(z => z.fish.map(f => f.id))));
  $("dexAll").textContent = ALL_FISH_IDS.length;
  $("dexAll2").textContent = ALL_FISH_IDS.length;

  // Save
  const SAVE_KEY = "idle_fishing_clean_save_v1";
  const SAVE_VER = 1;

  let S = null;

  function defaultState(){
    return {
      v: SAVE_VER,
      gold: 0,
      totalGold: 0,
      totalCatch: 0,
      totalSold: 0,
      rodLv: 1,
      zoneIdx: 0,
      bagCap: 30,
      bag: [],
      dex: {},
      job: { active:false, zoneIdx:0, startAt:0, endAt:0, planned:[] },
      log: []
    };
  }

  function saveLocal(){
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }catch(_){}
  }
  function loadLocal(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }

  function pushLog(msg){
    const t = new Date().toLocaleString();
    S.log.unshift({t, msg});
    if(S.log.length > 80) S.log.pop();
    renderLog();
  }

  // Save code (backup)
  function b64encode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }
  function b64decode(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
  function checksum(str){
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619) >>> 0;
    }
    return (h >>> 0).toString(36).toUpperCase().padStart(6, "0").slice(0,6);
  }
  function exportCode(){
    const json = JSON.stringify(S);
    const b64 = b64encode(json);
    return `v${SAVE_VER}:${b64}:${checksum(b64)}`;
  }
  function importCode(code){
    const m = String(code || "").trim().match(/^v(\d+):([A-Za-z0-9+/=]+):([A-Za-z0-9]+)$/);
    if(!m) throw new Error("æ ¼å¼ä¸æ­£ç¢º");
    const b64 = m[2];
    const chk = m[3].toUpperCase();
    if(checksum(b64) !== chk) throw new Error("æ ¡é©—å¤±æ•—ï¼ˆå¯èƒ½è²¼éŒ¯ï¼‰");
    const obj = JSON.parse(b64decode(b64));
    if(!obj || obj.v !== SAVE_VER) throw new Error("ç‰ˆæœ¬ä¸ç›¸å®¹");
    return obj;
  }

  // Gameplay helpers
  function curZone(){ return ZONES[clamp(S.zoneIdx, 0, ZONES.length-1)]; }
  function nextZone(){ return ZONES[S.zoneIdx + 1] || null; }
  function bagCount(){ return S.bag.reduce((a,x)=>a+x.q, 0); }
  function bagHasSpace(n){ return bagCount() + n <= S.bagCap; }

  function fishById(id){
    for(const z of ZONES){
      const f = z.fish.find(x => x.id === id);
      if(f) return f;
    }
    return null;
  }

  function priceOfFish(fish){
    const r = RAR[fish.rar] || RAR.C;
    const zoneMult = 1 + (S.zoneIdx * 0.18);
    return Math.round(fish.base * r.mult * zoneMult);
  }

  function rodTimeSec(){
    const base = curZone().baseTimeSec;
    const factor = Math.pow(0.92, S.rodLv - 1);
    return Math.max(7, Math.round(base * factor));
  }
  function rodQualityBonus(){ return Math.min(0.55, (S.rodLv - 1) * 0.035); }

  function weightedPick(list){
    const total = list.reduce((a,x)=>a + x.w, 0);
    let r = Math.random() * total;
    for(const x of list){
      r -= x.w;
      if(r <= 0) return x;
    }
    return list[list.length-1];
  }

  function makeZoneFishTable(){
    const z = curZone();
    const q = rodQualityBonus();
    return z.fish.map(f => {
      let w = f.w;
      if(f.rar==="U") w *= (1 + q * 0.9);
      if(f.rar==="R") w *= (1 + q * 1.4);
      if(f.rar==="E") w *= (1 + q * 2.0);
      if(f.rar==="L") w *= (1 + q * 2.6);
      if(f.rar==="C") w *= (1 - q * 0.35);
      return {...f, w: Math.max(0.2, w)};
    });
  }

  function addToBag(fishId, qty){
    const it = S.bag.find(x => x.id === fishId);
    if(it) it.q += qty;
    else S.bag.push({id: fishId, q: qty});
  }

  function planCatch(){
    const extraChance = clamp((S.rodLv-1) * 0.12, 0, 0.55);
    let n = 1;
    if(Math.random() < extraChance) n += 1;
    if(Math.random() < extraChance * 0.33) n += 1;
    n = clamp(n, 1, 3);

    const table = makeZoneFishTable();
    const planned = [];
    for(let i=0;i<n;i++){
      const f = weightedPick(table);
      planned.push({id:f.id, q:1});
    }
    return planned;
  }

  function startJob(){
    if(S.job.active){ showToast(`ç›®å‰é‡£é­šä¸­ï¼Œå…ˆçµç®—`, 900); return; }
    const planned = planCatch();
    if(!bagHasSpace(planned.length)){ showToast(`<b>èƒŒåŒ…æ»¿äº†</b>ï¼Œå…ˆè³£æ‰`, 1000); return; }
    const sec = rodTimeSec();
    const t0 = now();
    S.job = { active:true, zoneIdx:S.zoneIdx, startAt:t0, endAt:t0 + sec*1000, planned };
    pushLog(`ğŸ£ é–‹å§‹é‡£é­šï¼ˆ${curZone().name}ï¼‰é è¨ˆ ${sec}sï¼Œç›®æ¨™ ${planned.length} æ¢`);
    saveLocal();
    renderAll();
  }

  function settleJob(force=false){
    if(!S.job.active){ showToast(`æ²’æœ‰ä»»å‹™`, 700); return; }
    if(now() < S.job.endAt && !force){ showToast(`é‚„æ²’é‡£å®Œ`, 650); return; }

    const got = S.job.planned.slice();
    for(const p of got){
      addToBag(p.id, p.q);
      S.dex[p.id] = true;
    }
    S.totalCatch += got.length;

    const names = got.map(p => fishById(p.id)?.name || p.id).join("ã€");
    pushLog(`âœ… çµç®—ï¼š${names}ï¼ˆ+${got.length}ï¼‰`);
    S.job = { active:false, zoneIdx:S.zoneIdx, startAt:0, endAt:0, planned:[] };

    saveLocal();
    renderAll();
    showToast(`æ”¶é­šå®Œæˆï¼š<b>+${got.length}</b>`, 900);
  }

  function sellAll(){
    const cnt = bagCount();
    if(cnt <= 0){ showToast(`èƒŒåŒ…ç©ºçš„`, 800); return; }
    let gold = 0;
    for(const it of S.bag){
      const f = fishById(it.id);
      if(!f) continue;
      gold += priceOfFish(f) * it.q;
    }
    S.bag = [];
    S.gold += gold;
    S.totalGold += gold;
    S.totalSold += cnt;

    pushLog(`ğŸ’° è³£å‡º ${cnt} æ¢ â†’ +${gold} é‡‘å¹£`);
    saveLocal();
    renderAll();
    showToast(`è³£å‡ºå®Œæˆï¼š<b>+${gold}</b>`, 900);
  }

  function rodUpCost(){
    const lv = S.rodLv;
    return Math.round(180 * Math.pow(1.55, lv-1));
  }
  function upgradeRod(){
    const cost = rodUpCost();
    if(S.gold < cost){ showToast(`é‡‘å¹£ä¸è¶³ï¼ˆéœ€è¦ <b>${cost}</b>ï¼‰`, 900); return; }
    S.gold -= cost;
    S.rodLv += 1;
    pushLog(`â¬†ï¸ é‡£ç«¿å‡ç´šï¼šLv ${S.rodLv}ï¼ˆ-${cost}ï¼‰`);
    saveLocal();
    renderAll();
    showToast(`å‡ç´šæˆåŠŸï¼š<b>Lv ${S.rodLv}</b>`, 900);
  }

  function unlockNextZone(){
    const nz = nextZone();
    if(!nz){ showToast(`å·²åˆ°æœ€å¾Œæ°´åŸŸ`, 900); return; }
    if(S.job.active){ showToast(`å…ˆçµç®—ä»»å‹™`, 900); return; }
    if(S.gold < nz.unlockGold){ showToast(`é‡‘å¹£ä¸è¶³ï¼ˆéœ€è¦ <b>${nz.unlockGold}</b>ï¼‰`, 900); return; }
    S.gold -= nz.unlockGold;
    S.zoneIdx += 1;
    pushLog(`ğŸŒŠ è§£é–æ°´åŸŸï¼š${curZone().name}ï¼ˆ-${nz.unlockGold}ï¼‰`);
    saveLocal();
    renderAll();
    showToast(`è§£é–æˆåŠŸï¼š<b>${curZone().name}</b>`, 900);
  }

  function applyOfflineSettlement(){
    if(!S.job.active) return;
    if(now() >= S.job.endAt){
      settleJob(true);
      showToast(`é›¢ç·šçµç®—å®Œæˆ âœ…`, 850);
    }
  }

  // Render
  function renderHeader(){
    $("gold").textContent = fmt(S.gold);
    $("rodLv").textContent = S.rodLv;
    $("zoneName").textContent = curZone().name;

    $("bag").textContent = bagCount();
    $("bag2").textContent = bagCount();
    $("bagCap").textContent = S.bagCap;
    $("bagCap2").textContent = S.bagCap;

    const dexCount = Object.keys(S.dex).length;
    $("dex").textContent = dexCount;
    $("dex2").textContent = dexCount;

    $("totalCatch").textContent = fmt(S.totalCatch);
    $("totalSold").textContent = fmt(S.totalSold);
    $("totalGold").textContent = fmt(S.totalGold);

    $("rodCost").textContent = rodUpCost();
    $("zoneCost").textContent = nextZone() ? nextZone().unlockGold : "â€”";
  }

  function renderJob(){
    if(!S.job.active){
      $("status").textContent = "å¾…å‘½";
      $("remain").textContent = "â€”";
      return;
    }
    $("status").textContent = "é‡£é­šä¸­";
    const r = Math.max(0, S.job.endAt - now());
    if(r <= 0){
      $("remain").textContent = "å¯çµç®—";
    }else{
      $("remain").textContent = `${Math.ceil(r/1000)}s`;
    }
  }

  function renderLog(){
    const box = $("log");
    box.innerHTML = "";
    if(!S.log.length){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logM" style="color:var(--muted); font-weight:800;">é‚„æ²’é–‹å§‹ã€‚æŒ‰ã€Œé–‹å§‹é‡£é­šã€å…ˆè·‘ä¸€å–®ã€‚</div>`;
      box.appendChild(div);
      return;
    }
    for(const it of S.log){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logT">${it.t}</div><div class="logM">${it.msg}</div>`;
      box.appendChild(div);
    }
  }

  function renderBagDialog(){
    const box = $("bagList");
    box.innerHTML = "";

    const bagSorted = [...S.bag].sort((a,b)=>a.id.localeCompare(b.id));
    if(!bagSorted.length){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="logM" style="color:var(--muted); font-weight:800;">èƒŒåŒ…ç©ºçš„ï¼Œå»é‡£å¹¾æ¢å†ä¾†ã€‚</div>`;
      box.appendChild(div);
    }else{
      for(const it of bagSorted){
        const f = fishById(it.id);
        const rar = f ? (RAR[f.rar]?.name || f.rar) : "æœªçŸ¥";
        const price = f ? priceOfFish(f) : 0;
        const div = document.createElement("div");
        div.className = "logItem";
        div.innerHTML = `
          <div class="logM">${f ? f.name : it.id}ï¼ˆ${rar}ï¼‰x ${it.q}ã€€ï½œã€€å–®åƒ¹ ${price}ã€€ï½œã€€å°è¨ˆ ${price*it.q}</div>
        `;
        box.appendChild(div);
      }
    }

    const div2 = document.createElement("div");
    div2.className = "logItem";
    div2.innerHTML = `<div class="logT">åœ–é‘‘ï¼ˆâœ… å·²è§£é– / â€” æœªè§£é–ï¼‰</div>`;
    box.appendChild(div2);

    const dexWrap = document.createElement("div");
    dexWrap.style.display = "flex";
    dexWrap.style.flexWrap = "wrap";
    dexWrap.style.gap = "8px";
    dexWrap.style.padding = "8px 6px 2px";
    for(const id of ALL_FISH_IDS){
      const f = fishById(id);
      const ok = !!S.dex[id];
      const chip = document.createElement("div");
      chip.className = "pill";
      chip.style.opacity = ok ? "1" : "0.55";
      chip.style.padding = "8px 10px";
      chip.textContent = `${ok ? "âœ…" : "â€”"} ${f ? f.name : id}`;
      dexWrap.appendChild(chip);
    }
    box.appendChild(dexWrap);
  }

  function renderAll(){
    renderHeader();
    renderJob();
    renderLog();
  }

  // UI events
  $("castBtn").addEventListener("click", () => startJob());
  $("claimBtn").addEventListener("click", () => settleJob(false));
  $("sellBtn").addEventListener("click", () => sellAll());
  $("rodUpBtn").addEventListener("click", () => upgradeRod());
  $("zoneUpBtn").addEventListener("click", () => unlockNextZone());

  // dialogs
  const dlgSave = $("dlgSave");
  $("saveBtn").addEventListener("click", () => {
    $("saveText").value = exportCode();
    dlgSave.showModal();
  });
  $("closeSave").addEventListener("click", () => dlgSave.close());
  $("closeSave2").addEventListener("click", () => dlgSave.close());

  $("btnExport").addEventListener("click", () => {
    $("saveText").value = exportCode();
    showToast(`å·²ç”¢ç”Ÿå­˜æª”ç¢¼`, 750);
  });
  $("btnCopy").addEventListener("click", async () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`æ²’æœ‰å…§å®¹å¯è¤‡è£½`, 700); return; }
    try{
      await navigator.clipboard.writeText(txt);
      showToast(`å·²è¤‡è£½ âœ…`, 750);
    }catch(_){
      $("saveText").focus();
      $("saveText").select();
      showToast(`å·²é¸å–ï¼Œæ‰‹å‹•è¤‡è£½`, 900);
    }
  });
  $("btnImport").addEventListener("click", () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`è«‹è²¼ä¸Šå­˜æª”ç¢¼`, 850); return; }
    try{
      S = importCode(txt);
      saveLocal();
      applyOfflineSettlement();
      renderAll();
      pushLog(`ğŸ“¥ åŒ¯å…¥å­˜æª”å®Œæˆ`);
      showToast(`<b>åŒ¯å…¥æˆåŠŸ</b>`, 900);
    }catch(e){
      showToast(`<b>åŒ¯å…¥å¤±æ•—</b>ï¼š${e.message}`, 1200);
    }
  });
  $("btnReset").addEventListener("click", () => {
    S = defaultState();
    saveLocal();
    renderAll();
    pushLog(`ğŸ§¨ å­˜æª”å·²é‡ç½®`);
    showToast(`<b>å·²é‡ç½®</b>`, 900);
  });

  const dlgBag = $("dlgBag");
  $("bagBtn").addEventListener("click", () => {
    renderBagDialog();
    dlgBag.showModal();
  });
  $("closeBag").addEventListener("click", () => dlgBag.close());
  $("closeBag2").addEventListener("click", () => dlgBag.close());

  const dlgHelp = $("dlgHelp");
  $("helpBtn").addEventListener("click", () => dlgHelp.showModal());
  $("closeHelp").addEventListener("click", () => dlgHelp.close());
  $("closeHelp2").addEventListener("click", () => dlgHelp.close());

  // boot
  function boot(){
    S = loadLocal() || defaultState();
    if(!S.v) S.v = SAVE_VER;
    if(!S.dex) S.dex = {};
    if(!Array.isArray(S.bag)) S.bag = [];
    if(!S.job) S.job = { active:false, zoneIdx:0, startAt:0, endAt:0, planned:[] };
    if(!Array.isArray(S.log)) S.log = [];

    applyOfflineSettlement();
    renderAll();

    setInterval(() => {
      renderJob();
      saveLocal();
    }, 1000);

    if(S.totalCatch === 0 && !S.job.active){
      showToast(`æŒ‰ã€Œ<b>é–‹å§‹é‡£é­š</b>ã€å…ˆè·‘ä¸€å–®`, 1200);
    }
  }
  boot();
})();
</script>
</body>
</html>