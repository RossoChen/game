<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Idle Fishing</title>

  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Fishing" />

  <link rel="manifest" href="/game/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/game/icons/icon-192.png">

  <style>
    :root{
      color-scheme: dark light;
      --homebar-guard: max(env(safe-area-inset-bottom), 34px);
      --homebar-extra: 14px;
      --maxw: 760px;
    }
    html[data-theme="dark"]{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.18);
      --border2:rgba(255,255,255,.14);
      --fg:#e7eefc;
      --muted:rgba(231,238,252,.82);
      --accent:#57b8ff;
      --good:#7cf7b6;
      --warn:#ffcc66;
      --bad:#ff668a;
      --shadow: rgba(0,0,0,.25);
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --panel:rgba(0,0,0,.06);
      --panel2:rgba(0,0,0,.04);
      --border:rgba(0,0,0,.12);
      --border2:rgba(0,0,0,.10);
      --fg:#0b1220;
      --muted:rgba(11,18,32,.74);
      --accent:#1e79c8;
      --good:#1ea972;
      --warn:#d9822b;
      --bad:#d23a5a;
      --shadow: rgba(0,0,0,.12);
    }

    html, body{
      margin:0; height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      background:var(--bg);
      color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
    }
    body{ position:fixed; inset:0; }

    .app{
      height:100svh;
      padding-top: calc(env(safe-area-inset-top) + 14px);
      padding-right: calc(env(safe-area-inset-right) + 12px);
      padding-bottom: calc(var(--homebar-guard) + var(--homebar-extra));
      padding-left: calc(env(safe-area-inset-left) + 12px);
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:min(var(--maxw), 96vw);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .leftTop, .rightTop{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--fg);
      border-radius:16px;
      padding:12px 14px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
      min-height:46px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px var(--shadow);
    }
    .btn:active{ transform:scale(0.985); }
    .btn.primary{ border-color: color-mix(in oklab, var(--accent), var(--border) 50%); }
    .btn.good{ border-color: color-mix(in oklab, var(--good), var(--border) 55%); }
    .btn.warn{ border-color: color-mix(in oklab, var(--warn), var(--border) 55%); }
    .btn.bad{ border-color: color-mix(in oklab, var(--bad), var(--border) 55%); }

    .pill{
      border:1px solid var(--border2);
      background:var(--panel2);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      text-align:center;
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }
    .pill strong{ font-weight:1000; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:12px;
      min-height:0;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--border2);
      background:var(--panel2);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 28px var(--shadow);
      backdrop-filter: blur(10px);
      min-height:0;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .kv{ grid-template-columns: 1fr; }
    }

    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height: 46svh;
      padding-right:2px;
    }
    .item{
      border:1px solid var(--border2);
      background:color-mix(in oklab, var(--panel2), transparent 0%);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .itL{ min-width:0; }
    .itT{
      font-weight:1000;
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .tag{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border2);
      background:var(--panel);
      white-space:nowrap;
      font-weight:900;
      opacity:.95;
    }
    .muted{ color:var(--muted); font-size:12px; line-height:1.35; }

    .toast{
      position:fixed;
      left:50%;
      top: calc(env(safe-area-inset-top) + 10px);
      transform:translateX(-50%);
      z-index:999;
      border:1px solid var(--border2);
      background:var(--panel);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:1000;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 28px var(--shadow);
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(6px); }
    .toast b{ color:var(--accent); }

    dialog{
      width:min(760px, 94vw);
      border:1px solid var(--border2);
      background:var(--bg);
      color:var(--fg);
      border-radius:18px;
      box-shadow: 0 20px 60px var(--shadow);
      padding:0;
    }
    dialog::backdrop{ background: rgba(0,0,0,.35); }
    .dlgHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dlgHead h3{ margin:0; font-size:15px; }
    .dlgBody{ padding:14px; display:flex; flex-direction:column; gap:10px; }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--border2);
      background:var(--panel2);
      color:var(--fg);
      padding:12px;
      font-size:13px;
      line-height:1.4;
      outline:none;
    }
    .dlgFoot{
      padding:14px;
      border-top:1px solid var(--border2);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="wrap">
      <div class="topbar">
        <div class="leftTop">
          <button class="btn" id="backBtn">â† Back</button>
          <button class="btn" id="themeBtn">ä¸»é¡Œï¼šæ·±è‰²</button>
          <button class="btn" id="saveBtn">å­˜æª”ç¢¼</button>
        </div>
        <div class="rightTop">
          <div class="pill">é‡‘å¹£ï¼š<strong id="gold">0</strong></div>
          <div class="pill">é‡£ç«¿ï¼šLv <strong id="rodLv">1</strong></div>
          <div class="pill">æ°´åŸŸï¼š<strong id="zoneName">æ–°æ‰‹æ± </strong></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>é‡£é­šä½œæ¥­é¢æ¿</h2>
          <p class="sub">é€™ä¸æ˜¯åæ‡‰éŠæˆ²ï¼Œæ˜¯ KPI é”æˆéŠæˆ²ï¼š<b>æ´¾é£ â†’ çµç®— â†’ è®Šæœ‰éŒ¢</b>ã€‚é›¢ç·šä¹Ÿæœƒç®—ï¼Œæ”¾å¿ƒã€‚</p>

          <div class="kv">
            <div class="pill">ç‹€æ…‹ï¼š<strong id="status">å¾…å‘½</strong></div>
            <div class="pill">å‰©é¤˜ï¼š<strong id="remain">â€”</strong></div>
            <div class="pill">èƒŒåŒ…ï¼š<strong id="bag">0</strong>/<strong id="bagCap">30</strong></div>
            <div class="pill">é­šåœ–é‘‘ï¼š<strong id="dex">0</strong>/<strong id="dexAll">0</strong></div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="castBtn">ğŸ£ é–‹å§‹é‡£é­š</button>
            <button class="btn good" id="claimBtn">âœ… çµç®—æ”¶é­š</button>
            <button class="btn warn" id="sellBtn">ğŸ’° å…¨éƒ¨è³£æ‰</button>
            <div class="spacer"></div>
            <button class="btn" id="bagBtn">ğŸ“¦ èƒŒåŒ…/åœ–é‘‘</button>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="padding:12px; box-shadow:none;">
            <h2 style="margin:0 0 10px; font-size:15px;">å‡ç´šèˆ‡è§£é–</h2>
            <div class="row">
              <div class="pill">é‡£ç«¿å‡ç´šè²»ï¼š<strong id="rodCost">â€”</strong></div>
              <button class="btn good" id="rodUpBtn">â¬†ï¸ å‡ç´šé‡£ç«¿</button>
              <div class="spacer"></div>
              <div class="pill">æ°´åŸŸè§£é–è²»ï¼š<strong id="zoneCost">â€”</strong></div>
              <button class="btn primary" id="zoneUpBtn">ğŸŒŠ è§£é–ä¸‹ä¸€æ°´åŸŸ</button>
            </div>
            <p class="sub" style="margin:10px 0 0;">
              é‡£ç«¿ç­‰ç´šå½±éŸ¿ï¼š<b>é‡£é­šæ™‚é–“</b>ã€<b>æ‰è½å“è³ª</b>ï¼›æ°´åŸŸå½±éŸ¿ï¼š<b>é­šç¨®</b>èˆ‡<b>å–®åƒ¹</b>ã€‚
            </p>
          </div>
        </div>

        <div class="card">
          <h2>æœ¬æ¬¡ä½œæ¥­ç´€éŒ„</h2>
          <p class="sub">ä½ ä¸æ˜¯åœ¨é‡£é­šï¼Œä½ æ˜¯åœ¨è·‘ä¸€å€‹ã€Œéš¨æ©Ÿç”¢å‡ºã€çš„å·¥ä½œæµã€‚å¾ˆå¥½ã€‚</p>

          <div class="list" id="log"></div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="pill">ç¸½é‡£ç²ï¼š<strong id="totalCatch">0</strong></div>
            <div class="pill">ç¸½è³£å‡ºï¼š<strong id="totalSold">0</strong></div>
            <div class="pill">ç´¯ç©é‡‘å¹£ï¼š<strong id="totalGold">0</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å­˜æª”ç¢¼ Dialog -->
  <dialog id="dlgSave">
    <div class="dlgHead">
      <h3>å­˜æª”ç¢¼ï¼ˆå¯æ›æ©Ÿ/é˜²æ¸…é™¤ï¼‰</h3>
      <button class="btn" id="closeSave">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="muted">
        åŸå‰‡ï¼š<b>è‡ªå‹•æœ¬æ©Ÿå­˜æª”</b> + <b>å­˜æª”ç¢¼å‚™ä»½</b>ã€‚æ¸…é™¤ç€è¦½è³‡æ–™æœƒæ‰æœ¬æ©Ÿå­˜æª”ï¼Œä½†å­˜æª”ç¢¼å¯ä»¥æ•‘å›ä¾†ã€‚
      </div>
      <textarea id="saveText" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä½ çš„å­˜æª”ç¢¼â€¦"></textarea>
      <div class="row">
        <button class="btn good" id="btnExport">åŒ¯å‡ºå­˜æª”ç¢¼</button>
        <button class="btn" id="btnCopy">è¤‡è£½</button>
        <div class="spacer"></div>
        <button class="btn warn" id="btnImport">åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
        <button class="btn bad" id="btnReset">é‡ç½®å­˜æª”</button>
      </div>
    </div>
    <div class="dlgFoot">
      <button class="btn" id="closeSave2">OK</button>
    </div>
  </dialog>

  <!-- èƒŒåŒ… Dialog -->
  <dialog id="dlgBag">
    <div class="dlgHead">
      <h3>èƒŒåŒ… / åœ–é‘‘</h3>
      <button class="btn" id="closeBag">é—œé–‰</button>
    </div>
    <div class="dlgBody">
      <div class="row">
        <div class="pill">èƒŒåŒ…ï¼š<strong id="bag2">0</strong>/<strong id="bagCap2">30</strong></div>
        <div class="pill">åœ–é‘‘ï¼š<strong id="dex2">0</strong>/<strong id="dexAll2">0</strong></div>
      </div>
      <div class="list" id="bagList" style="max-height:56svh;"></div>
    </div>
    <div class="dlgFoot">
      <button class="btn" id="closeBag2">OK</button>
    </div>
  </dialog>

<script>
(() => {
  // ========= Utilities =========
  const $ = (id) => document.getElementById(id);
  const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
  const fmt = (n) => (Math.floor(n) === n ? String(n) : n.toFixed(2));
  const now = () => Date.now();

  const toast = $("toast");
  let toastTimer = 0;
  function showToast(msg, ms=900){
    toast.innerHTML = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
  }

  // ========= Theme =========
  const THEME_KEY = "idle_fishing_theme_v1";
  function systemTheme(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
  }
  function applyTheme(mode){
    const final = (mode === "system") ? systemTheme() : mode;
    document.documentElement.dataset.theme = final;
    const meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute("content", final === "light" ? "#f6f7fb" : "#0b1220");
    $("themeBtn").textContent = `ä¸»é¡Œï¼š${final === "light" ? "æ·ºè‰²" : "æ·±è‰²"}`;
  }
  function getThemeMode(){ return localStorage.getItem(THEME_KEY) || "system"; }
  function setThemeMode(mode){ localStorage.setItem(THEME_KEY, mode); applyTheme(mode); }
  applyTheme(getThemeMode());
  if(window.matchMedia){
    window.matchMedia("(prefers-color-scheme: light)").addEventListener?.("change", () => {
      if(getThemeMode() === "system") applyTheme("system");
    });
  }
  $("themeBtn").addEventListener("click", () => {
    const cur = document.documentElement.dataset.theme;
    setThemeMode(cur === "light" ? "dark" : "light");
  });

  // ========= Back =========
  $("backBtn").addEventListener("click", () => {
    const hub = "/game/";
    try{
      if(document.referrer && document.referrer.includes("/game/")) history.back();
      else location.href = hub;
    }catch(_){
      location.href = hub;
    }
  });

  // ========= Game Data =========
  // ç¨€æœ‰åº¦ï¼šè¶Šç¨€æœ‰è¶Šè²´
  const RAR = {
    C: {name:"æ™®é€š", tag:"C", mult:1.0},
    U: {name:"å°‘è¦‹", tag:"U", mult:1.6},
    R: {name:"ç¨€æœ‰", tag:"R", mult:2.6},
    E: {name:"å²è©©", tag:"E", mult:4.2},
    L: {name:"å‚³èªª", tag:"L", mult:7.0},
  };

  // æ°´åŸŸï¼ˆé€æ­¥è§£é–ï¼‰
  const ZONES = [
    {
      id:"pond",
      name:"æ–°æ‰‹æ± ",
      unlockGold: 0,
      baseTimeSec: 18,
      fish: [
        {id:"minnow",  name:"å°éŠ€é­š", base: 6,  rar:"C", w:60},
        {id:"carp",    name:"é¯‰é­š",   base: 10, rar:"C", w:45},
        {id:"catfish", name:"é¯°é­š",   base: 16, rar:"U", w:24},
        {id:"eel",     name:"é°»é­š",   base: 22, rar:"R", w:10},
        {id:"koi",     name:"éŒ¦é¯‰",   base: 40, rar:"E", w:4},
      ]
    },
    {
      id:"river",
      name:"æºªæµ",
      unlockGold: 600,
      baseTimeSec: 24,
      fish: [
        {id:"trout",   name:"é±’é­š",   base: 18, rar:"C", w:55},
        {id:"bass",    name:"é±¸é­š",   base: 26, rar:"U", w:28},
        {id:"pike",    name:"ç‹—é­š",   base: 38, rar:"R", w:12},
        {id:"golden",  name:"é‡‘é±—é­š", base: 60, rar:"E", w:4},
        {id:"spirit",  name:"éˆæ°´é­š", base: 95, rar:"L", w:1},
      ]
    },
    {
      id:"lake",
      name:"æ·±æ¹–",
      unlockGold: 2600,
      baseTimeSec: 30,
      fish: [
        {id:"perch",    name:"æ²³é±¸",   base: 28,  rar:"C", w:52},
        {id:"tilapia",  name:"å³éƒ­é­š", base: 34,  rar:"U", w:30},
        {id:"sturgeon", name:"é±˜é­š",   base: 70,  rar:"R", w:12},
        {id:"moon",     name:"æœˆå½±é­š", base: 120, rar:"E", w:5},
        {id:"ancient",  name:"å¤ä»£é­š", base: 180, rar:"L", w:1},
      ]
    },
  ];

  // å…¨é­šç¨®æ•¸ï¼ˆåœ–é‘‘ï¼‰
  const ALL_FISH_IDS = Array.from(new Set(ZONES.flatMap(z => z.fish.map(f => f.id))));
  $("dexAll").textContent = ALL_FISH_IDS.length;
  $("dexAll2").textContent = ALL_FISH_IDS.length;

  // ========= Save Model =========
  const SAVE_KEY = "idle_fishing_save_v1";
  const SAVE_VER = 1;

  // state:
  // gold, totalGold, totalCatch, totalSold
  // rodLv, zoneIdx
  // bag: [{id, q}]
  // dex: {id:true}
  // job: {active, zoneIdx, startAt, endAt, planCount, planned: [{id, q, price}]}
  // log: [{t, msg}]
  let S = null;

  function defaultState(){
    return {
      v: SAVE_VER,
      gold: 0,
      totalGold: 0,
      totalCatch: 0,
      totalSold: 0,

      rodLv: 1,
      zoneIdx: 0,

      bagCap: 30,
      bag: [],

      dex: {},

      job: {
        active: false,
        zoneIdx: 0,
        startAt: 0,
        endAt: 0,
        planned: [] // planned catches
      },

      log: []
    };
  }

  function pushLog(msg){
    const t = new Date().toLocaleString();
    S.log.unshift({t, msg});
    if(S.log.length > 60) S.log.pop();
    renderLog();
  }

  function saveLocal(){
    try{
      localStorage.setItem(SAVE_KEY, JSON.stringify(S));
    }catch(e){
      // iOS storage full / blocked
      showToast(`<b>å­˜æª”å¤±æ•—</b>ï¼šç©ºé–“ä¸è¶³æˆ–è¢«é™åˆ¶`, 1200);
    }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return null;
      return obj;
    }catch(_){
      return null;
    }
  }

  // ========= Save Code (export/import) =========
  // æ ¼å¼ï¼šv1:<base64(json)>:<chk>
  // chk = ç°¡å–® hashï¼ˆé˜²è²¼éŒ¯ï¼Œä¸æ˜¯é˜²ä½œå¼Šï¼‰
  function b64encode(str){
    // UTF-8 safe
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }
  function b64decode(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
  function checksum(str){
    // FNV-1a like (ç°¡åŒ–)
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619) >>> 0;
    }
    // è½‰æˆ 4 bytes base36
    return (h >>> 0).toString(36).toUpperCase().padStart(6, "0").slice(0,6);
  }
  function exportCode(){
    const json = JSON.stringify(S);
    const b64 = b64encode(json);
    const chk = checksum(b64);
    return `v${SAVE_VER}:${b64}:${chk}`;
  }
  function importCode(code){
    const m = String(code || "").trim().match(/^v(\d+):([A-Za-z0-9+/=]+):([A-Za-z0-9]+)$/);
    if(!m) throw new Error("æ ¼å¼ä¸æ­£ç¢º");
    const ver = Number(m[1]);
    const b64 = m[2];
    const chk = m[3].toUpperCase();
    const c = checksum(b64);
    if(c !== chk) throw new Error("æ ¡é©—å¤±æ•—ï¼ˆå¯èƒ½è²¼éŒ¯æˆ–è¢«æ”¹éï¼‰");
    const json = b64decode(b64);
    const obj = JSON.parse(json);
    if(!obj || typeof obj !== "object") throw new Error("å…§å®¹ä¸å¯è§£æ");
    if(obj.v !== SAVE_VER){
      // ç›®å‰åªæœ‰ v1ï¼Œæœªä¾†å¯ä»¥åœ¨é€™è£¡åšç›¸å®¹è½‰æ›
      throw new Error(`ç‰ˆæœ¬ä¸ç›¸å®¹ï¼ˆå­˜æª” v${obj.v}ï¼Œç›®å‰æ”¯æ´ v${SAVE_VER}ï¼‰`);
    }
    return obj;
  }

  // ========= Gameplay =========
  function curZone(){ return ZONES[clamp(S.zoneIdx, 0, ZONES.length-1)]; }
  function rodTimeSec(){
    // rodLv è¶Šé«˜ï¼Œé‡£é­šæ™‚é–“è¶ŠçŸ­ï¼ˆæœ€ä½ 7 ç§’ï¼‰
    const z = curZone();
    const base = z.baseTimeSec;
    const factor = Math.pow(0.92, S.rodLv - 1);
    return Math.max(7, Math.round(base * factor));
  }
  function rodQualityBonus(){
    // é‡£ç«¿å“è³ªåŠ æˆï¼šæé«˜ç¨€æœ‰é­šæ¬Šé‡ï¼ˆä¸æ˜¯æš´åŠ›ï¼Œæ…¢æ…¢åŠ ï¼‰
    // å›å‚³ä¸€å€‹ 0~? çš„å€¼ï¼Œç”¨æ–¼ç¨€æœ‰åŠ æ¬Š
    return Math.min(0.55, (S.rodLv - 1) * 0.035);
  }

  function bagCount(){
    return S.bag.reduce((a,x)=>a+x.q, 0);
  }
  function bagHasSpace(n){
    return bagCount() + n <= S.bagCap;
  }

  function addToBag(fishId, qty){
    const it = S.bag.find(x => x.id === fishId);
    if(it) it.q += qty;
    else S.bag.push({id: fishId, q: qty});
  }

  function fishById(id){
    for(const z of ZONES){
      const f = z.fish.find(x => x.id === id);
      if(f) return f;
    }
    return null;
  }

  function priceOfFish(fish){
    const r = RAR[fish.rar] || RAR.C;
    const zoneMult = 1 + (S.zoneIdx * 0.18);
    return Math.round(fish.base * r.mult * zoneMult);
  }

  function weightedPick(list){
    const total = list.reduce((a,x)=>a + x.w, 0);
    let r = Math.random() * total;
    for(const x of list){
      r -= x.w;
      if(r <= 0) return x;
    }
    return list[list.length-1];
  }

  function makeZoneFishTable(){
    const z = curZone();
    const qBonus = rodQualityBonus();

    // é‡£ç«¿åŠ æˆï¼šå° U/R/E/L é€ç´šåŠ æ¬Šï¼›åŒæ™‚ç•¥é™æ™®é€šï¼Œé¿å…ç¸½é‡çˆ†è¡¨
    const out = z.fish.map(f => {
      let w = f.w;
      if(f.rar === "U") w *= (1 + qBonus * 0.9);
      if(f.rar === "R") w *= (1 + qBonus * 1.4);
      if(f.rar === "E") w *= (1 + qBonus * 2.0);
      if(f.rar === "L") w *= (1 + qBonus * 2.6);
      if(f.rar === "C") w *= (1 - qBonus * 0.35);
      return {...f, w: Math.max(0.2, w)};
    });
    return out;
  }

  function planCatch(){
    // æœ¬æ¬¡é‡£é­šæœƒæŠ“å¹¾æ¢ï¼š1~(1+rod bonus)
    const base = 1;
    const extraChance = clamp((S.rodLv-1) * 0.12, 0, 0.55);
    let n = base;
    if(Math.random() < extraChance) n += 1;
    if(Math.random() < extraChance * 0.33) n += 1;
    n = clamp(n, 1, 3);

    const table = makeZoneFishTable();
    const planned = [];
    for(let i=0;i<n;i++){
      const f = weightedPick(table);
      const price = priceOfFish(f);
      planned.push({id:f.id, q:1, price});
    }
    return planned;
  }

  function startJob(){
    if(S.job.active){
      showToast(`ç›®å‰æ­£åœ¨é‡£é­šï¼Œå…ˆ<b>çµç®—</b>å†èªª`, 900);
      return;
    }
    const planned = planCatch();
    if(!bagHasSpace(planned.length)){
      showToast(`<b>èƒŒåŒ…æ»¿äº†</b>ï¼Œå…ˆè³£æ‰æˆ–æ¸…èƒŒåŒ…`, 1100);
      return;
    }
    const sec = rodTimeSec();
    const t0 = now();
    S.job = {
      active: true,
      zoneIdx: S.zoneIdx,
      startAt: t0,
      endAt: t0 + sec*1000,
      planned
    };
    pushLog(`ğŸ£ é–‹å§‹é‡£é­šï¼ˆ${curZone().name}ï¼‰ï¼Œé è¨ˆ ${sec}sï¼Œç›®æ¨™ ${planned.length} æ¢`);
    saveLocal();
    renderAll();
  }

  function settleJob(force=false){
    if(!S.job.active){
      showToast(`æ²’æœ‰é€²è¡Œä¸­çš„é‡£é­šä»»å‹™`, 700);
      return;
    }
    const t = now();
    if(t < S.job.endAt && !force){
      showToast(`é‚„æ²’é‡£å®Œï¼Œåˆ¥æ€¥`, 650);
      return;
    }

    // åŠ å…¥èƒŒåŒ… + æ›´æ–°åœ–é‘‘
    let got = [];
    for(const p of S.job.planned){
      addToBag(p.id, p.q);
      S.dex[p.id] = true;
      got.push(p);
    }
    S.totalCatch += got.length;

    const zoneName = ZONES[S.job.zoneIdx]?.name || curZone().name;
    const summary = got.map(p => fishById(p.id)?.name || p.id).join("ã€");
    pushLog(`âœ… çµç®—å®Œæˆï¼ˆ${zoneName}ï¼‰ï¼š${summary || "ç©ºæ‰‹"}ï¼ˆ+${got.length}ï¼‰`);

    S.job.active = false;
    S.job.planned = [];
    S.job.startAt = 0;
    S.job.endAt = 0;

    saveLocal();
    renderAll();
    showToast(`æ”¶é­šå®Œæˆï¼š<b>+${got.length}</b>`, 900);
  }

  function sellAll(){
    const cnt = bagCount();
    if(cnt <= 0){
      showToast(`èƒŒåŒ…ç©ºçš„ï¼Œè³£å€‹å¯‚å¯`, 800);
      return;
    }
    let gold = 0;
    for(const it of S.bag){
      const f = fishById(it.id);
      if(!f) continue;
      gold += priceOfFish(f) * it.q;
    }
    S.bag = [];
    S.gold += gold;
    S.totalGold += gold;
    S.totalSold += cnt;

    pushLog(`ğŸ’° å…¨éƒ¨è³£å‡ºï¼š${cnt} æ¢ â†’ +${gold} é‡‘å¹£`);
    saveLocal();
    renderAll();
    showToast(`è³£å‡ºå®Œæˆï¼š<b>+${gold}</b>`, 900);
  }

  function rodUpCost(){
    // ç·©æ…¢æˆé•·ï¼šä¸è®“ä½  2 åˆ†é˜å°±å°é ‚
    const lv = S.rodLv;
    return Math.round(180 * Math.pow(1.55, lv-1));
  }

  function upgradeRod(){
    const cost = rodUpCost();
    if(S.gold < cost){
      showToast(`é‡‘å¹£ä¸è¶³ï¼ˆéœ€è¦ <b>${cost}</b>ï¼‰`, 900);
      return;
    }
    S.gold -= cost;
    S.rodLv += 1;
    pushLog(`â¬†ï¸ é‡£ç«¿å‡ç´šï¼šLv ${S.rodLv}ï¼ˆèŠ±è²» ${cost}ï¼‰`);
    saveLocal();
    renderAll();
    showToast(`é‡£ç«¿å‡ç´šæˆåŠŸï¼š<b>Lv ${S.rodLv}</b>`, 900);
  }

  function nextZone(){
    return ZONES[S.zoneIdx + 1] || null;
  }

  function unlockNextZone(){
    const nz = nextZone();
    if(!nz){
      showToast(`å·²åˆ°æœ€å¾Œæ°´åŸŸï¼Œæ­å–œä½  KPI å°é ‚`, 1000);
      return;
    }
    if(S.gold < nz.unlockGold){
      showToast(`é‡‘å¹£ä¸è¶³ï¼ˆéœ€è¦ <b>${nz.unlockGold}</b>ï¼‰`, 900);
      return;
    }
    if(S.job.active){
      showToast(`å…ˆçµç®—ç•¶å‰é‡£é­šä»»å‹™å†è§£é–`, 900);
      return;
    }
    S.gold -= nz.unlockGold;
    S.zoneIdx += 1;
    pushLog(`ğŸŒŠ è§£é–æ°´åŸŸï¼š${curZone().name}ï¼ˆèŠ±è²» ${nz.unlockGold}ï¼‰`);
    saveLocal();
    renderAll();
    showToast(`è§£é–æˆåŠŸï¼š<b>${curZone().name}</b>`, 900);
  }

  // ========= Offline Progress =========
  function applyOfflineSettlement(){
    if(!S.job.active) return;
    const t = now();
    if(t >= S.job.endAt){
      // ä»»å‹™å·²åˆ°æœŸï¼Œè‡ªå‹•çµç®—ï¼ˆä¸å¼·åˆ¶æç¤ºæ“‹ä½ï¼‰
      settleJob(true);
      showToast(`é›¢ç·šçµç®—å·²å®Œæˆ âœ…`, 850);
    }
  }

  // ========= Render =========
  function renderHeader(){
    $("gold").textContent = fmt(S.gold);
    $("rodLv").textContent = S.rodLv;
    $("zoneName").textContent = curZone().name;

    $("bag").textContent = bagCount();
    $("bag2").textContent = bagCount();
    $("bagCap").textContent = S.bagCap;
    $("bagCap2").textContent = S.bagCap;

    const dexCount = Object.keys(S.dex).length;
    $("dex").textContent = dexCount;
    $("dex2").textContent = dexCount;

    $("totalCatch").textContent = fmt(S.totalCatch);
    $("totalSold").textContent  = fmt(S.totalSold);
    $("totalGold").textContent  = fmt(S.totalGold);

    $("rodCost").textContent = rodUpCost();
    $("zoneCost").textContent = nextZone() ? nextZone().unlockGold : "â€”";
  }

  function renderJob(){
    if(!S.job.active){
      $("status").textContent = "å¾…å‘½";
      $("remain").textContent = "â€”";
      return;
    }
    $("status").textContent = "é‡£é­šä¸­";
    const r = Math.max(0, S.job.endAt - now());
    const sec = Math.ceil(r / 1000);
    $("remain").textContent = `${sec}s`;
  }

  function renderLog(){
    const box = $("log");
    box.innerHTML = "";
    if(!S.log.length){
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "é‚„æ²’é–‹å§‹ä½œæ¥­ã€‚æŒ‰ã€Œé–‹å§‹é‡£é­šã€å…ˆè·‘ä¸€å–®ã€‚";
      box.appendChild(div);
      return;
    }
    for(const it of S.log){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itL">
          <div class="itT"><span class="tag">${it.t}</span><span style="font-weight:900;">${it.msg}</span></div>
        </div>
      `;
      box.appendChild(div);
    }
  }

  function renderBagDialog(){
    const box = $("bagList");
    box.innerHTML = "";

    const dexCount = Object.keys(S.dex).length;

    const section1 = document.createElement("div");
    section1.className = "muted";
    section1.innerHTML = `èƒŒåŒ…å…§å®¹ï¼ˆå¯è³£æ‰æ›é‡‘å¹£ï¼‰ã€‚åœ–é‘‘è§£é–ï¼š<b>${dexCount}</b> / <b>${ALL_FISH_IDS.length}</b>`;
    box.appendChild(section1);

    const bagSorted = [...S.bag].sort((a,b)=>a.id.localeCompare(b.id));
    if(!bagSorted.length){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div class="itL"><div class="itT">ğŸ“¦ èƒŒåŒ…ç©º</div><div class="muted">å»é‡£å¹¾æ¢å†ä¾†ã€‚</div></div>`;
      box.appendChild(div);
    }else{
      for(const it of bagSorted){
        const f = fishById(it.id);
        const rar = f ? (RAR[f.rar]?.name || f.rar) : "æœªçŸ¥";
        const price = f ? priceOfFish(f) : 0;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="itL">
            <div class="itT">
              <span style="font-weight:1000;">${f ? f.name : it.id}</span>
              <span class="tag">${rar}</span>
              <span class="tag">å–®åƒ¹ ${price}</span>
            </div>
            <div class="muted">æ•¸é‡ï¼š${it.q}</div>
          </div>
          <div class="pill">å°è¨ˆï¼š<strong>${price * it.q}</strong></div>
        `;
        box.appendChild(div);
      }
    }

    const section2 = document.createElement("div");
    section2.className = "muted";
    section2.style.marginTop = "6px";
    section2.textContent = "åœ–é‘‘ï¼ˆå·²è§£é– âœ… / æœªè§£é– â€”ï¼‰ï¼š";
    box.appendChild(section2);

    const dexWrap = document.createElement("div");
    dexWrap.style.display = "flex";
    dexWrap.style.flexWrap = "wrap";
    dexWrap.style.gap = "8px";
    dexWrap.style.marginTop = "4px";

    for(const id of ALL_FISH_IDS){
      const f = fishById(id);
      const ok = !!S.dex[id];
      const chip = document.createElement("div");
      chip.className = "tag";
      chip.style.opacity = ok ? "1" : "0.55";
      chip.textContent = `${ok ? "âœ…" : "â€”"} ${f ? f.name : id}`;
      dexWrap.appendChild(chip);
    }
    box.appendChild(dexWrap);
  }

  function renderAll(){
    renderHeader();
    renderJob();
    renderLog();
  }

  // ========= Tick =========
  function tick(){
    if(!S) return;
    if(S.job.active){
      renderJob();
      if(now() >= S.job.endAt){
        // ä¸è‡ªå‹•çµç®—ï¼Œç•™çµ¦ç©å®¶æŒ‰ã€Œçµç®—ã€æœ‰å„€å¼æ„Ÿ
        $("remain").textContent = "å¯çµç®—";
      }
    }
    requestAnimationFrame(()=>{});
  }

  // ========= UI Events =========
  $("castBtn").addEventListener("click", () => startJob());
  $("claimBtn").addEventListener("click", () => settleJob(false));
  $("sellBtn").addEventListener("click", () => sellAll());
  $("rodUpBtn").addEventListener("click", () => upgradeRod());
  $("zoneUpBtn").addEventListener("click", () => unlockNextZone());

  // Dialog: Save Code
  const dlgSave = $("dlgSave");
  $("saveBtn").addEventListener("click", () => {
    $("saveText").value = exportCode();
    dlgSave.showModal();
  });
  $("closeSave").addEventListener("click", () => dlgSave.close());
  $("closeSave2").addEventListener("click", () => dlgSave.close());

  $("btnExport").addEventListener("click", () => {
    $("saveText").value = exportCode();
    showToast(`å·²ç”¢ç”Ÿå­˜æª”ç¢¼`, 750);
  });
  $("btnCopy").addEventListener("click", async () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`æ²’æœ‰å…§å®¹å¯è¤‡è£½`, 700); return; }
    try{
      await navigator.clipboard.writeText(txt);
      showToast(`å·²è¤‡è£½ âœ…`, 750);
    }catch(_){
      $("saveText").focus();
      $("saveText").select();
      showToast(`å·²é¸å–ï¼Œæ‰‹å‹•è¤‡è£½`, 900);
    }
  });
  $("btnImport").addEventListener("click", () => {
    const txt = $("saveText").value.trim();
    if(!txt){ showToast(`è«‹è²¼ä¸Šå­˜æª”ç¢¼`, 850); return; }
    try{
      const obj = importCode(txt);
      S = obj;
      saveLocal();
      applyOfflineSettlement();
      renderAll();
      showToast(`<b>åŒ¯å…¥æˆåŠŸ</b>`, 900);
      pushLog(`ğŸ“¥ åŒ¯å…¥å­˜æª”å®Œæˆ`);
    }catch(e){
      showToast(`<b>åŒ¯å…¥å¤±æ•—</b>ï¼š${e.message}`, 1200);
    }
  });
  $("btnReset").addEventListener("click", () => {
    // ä¸åš confirmï¼ˆæ‰‹æ©Ÿéº»ç…©ï¼‰ï¼Œç›´æ¥é‡ç½®ä½†å…ˆæç¤º
    S = defaultState();
    saveLocal();
    renderAll();
    showToast(`<b>å·²é‡ç½®</b>`, 900);
    pushLog(`ğŸ§¨ å­˜æª”å·²é‡ç½®`);
  });

  // Dialog: Bag
  const dlgBag = $("dlgBag");
  $("bagBtn").addEventListener("click", () => {
    renderBagDialog();
    dlgBag.showModal();
  });
  $("closeBag").addEventListener("click", () => dlgBag.close());
  $("closeBag2").addEventListener("click", () => dlgBag.close());

  // ========= Boot =========
  function boot(){
    S = loadLocal() || defaultState();
    // åŸºæœ¬ä¿®å¾©ï¼ˆé¿å…èˆŠè³‡æ–™ç¼ºæ¬„ä½ï¼‰
    if(!S.v) S.v = SAVE_VER;
    if(!S.dex) S.dex = {};
    if(!Array.isArray(S.bag)) S.bag = [];
    if(!S.job) S.job = {active:false, zoneIdx:0, startAt:0, endAt:0, planned:[]};
    if(!Array.isArray(S.log)) S.log = [];

    applyOfflineSettlement();
    renderAll();

    // æ¯ 1 ç§’åˆ·æ–°ä¸€æ¬¡å‰©é¤˜æ™‚é–“ & è‡ªå‹•å­˜æª”ï¼ˆä¿å®ˆï¼‰
    setInterval(() => {
      tick();
      saveLocal();
    }, 1000);

    // é¦–æ¬¡æç¤º
    if(S.totalCatch === 0 && !S.job.active){
      showToast(`æŒ‰ã€Œ<b>é–‹å§‹é‡£é­š</b>ã€å…ˆè·‘ä¸€å–®`, 1200);
    }
  }

  boot();
})();
</script>
</body>
</html>